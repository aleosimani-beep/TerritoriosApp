<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Territorios App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #f4f6fb;
      color: #222;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 10px 16px;
      background: #1b4b82;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
    }
    main {
      flex: 1;
      padding: 12px 12px 64px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    p {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 14px;
    }
    .card-header {
      font-weight: 600;
      margin-bottom: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 14px;
      background: #1b4b82;
      color: white;
      cursor: pointer;
      margin-top: 6px;
    }
    button:active {
      transform: scale(0.98);
    }
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #d5d8e3;
      display: flex;
      justify-content: space-around;
      padding: 6px 0;
    }
    .nav-btn {
      flex: 1;
      text-align: center;
      font-size: 11px;
      color: #666;
      cursor: pointer;
      padding: 4px 0;
    }
    .nav-btn span {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
    }
    .nav-btn.active {
      color: #1b4b82;
      font-weight: 600;
    }

    .field-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d4e4;
      font-size: 14px;
      width: 100%;
      background: #f9f9fd;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .programa-semanal {
      display: grid;
      gap: 6px;
      margin-top: 8px;
    }
    .fila-dia {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .fila-dia span {
      width: 90px;
    }
  </style>
</head>
<body>
  <header>
    TERRITORIOS APP
  </header>

  <main>
    <!-- üè† INICIO -->
    <section id="inicio" class="section active">
      <div class="card">
        <div class="card-header">Salida de hoy</div>
        <p id="salida-hoy-texto">Todav√≠a no cargaste el programa semanal.</p>
      </div>

      <div class="card">
        <div class="card-header">Salidas de semana</div>
        <p>Carg√° el programa en la pesta√±a <strong>Salidas</strong>. Ac√° siempre vas a ver la salida del d√≠a seg√∫n el territorio cargado.</p>
      </div>

      <div class="card">
        <div class="card-header">Interesados</div>
        <p>En la pesta√±a <strong>Interesados</strong> pod√©s guardar nombre, direcci√≥n y observaciones.</p>
      </div>

      <div class="card">
        <div class="card-header">Mi Informe</div>
        <p>En <strong>Informe</strong> fij√°s metas de horas (mensual y anual septiembre‚Äìagosto) y vas registrando tus horas diarias.</p>
      </div>
    </section>

    <!-- üìÖ SALIDAS -->
    <section id="salidas" class="section">
      <h2>Salidas de semana</h2>

      <div class="card">
        <div class="card-header">Programa semanal por territorio</div>
        <p>Ingres√° el n√∫mero de territorio para cada d√≠a de la semana. Se guarda en este dispositivo.</p>

        <div class="programa-semanal">
          <div class="fila-dia">
            <span>Domingo</span>
            <input type="text" id="territorio-dia-0" placeholder="Ej: 12" />
          </div>
          <div class="fila-dia">
            <span>Lunes</span>
            <input type="text" id="territorio-dia-1" placeholder="Ej: 5" />
          </div>
          <div class="fila-dia">
            <span>Martes</span>
            <input type="text" id="territorio-dia-2" placeholder="Ej: 8" />
          </div>
          <div class="fila-dia">
            <span>Mi√©rcoles</span>
            <input type="text" id="territorio-dia-3" placeholder="Ej: 10" />
          </div>
          <div class="fila-dia">
            <span>Jueves</span>
            <input type="text" id="territorio-dia-4" placeholder="Ej: 3" />
          </div>
          <div class="fila-dia">
            <span>Viernes</span>
            <input type="text" id="territorio-dia-5" placeholder="Ej: 7" />
          </div>
          <div class="fila-dia">
            <span>S√°bado</span>
            <input type="text" id="territorio-dia-6" placeholder="Ej: 9" />
          </div>
        </div>

        <button id="btn-guardar-programa">Guardar programa semanal</button>
        <div id="estado-programa" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>
    </section>

    <!-- üó∫Ô∏è TERRITORIOS -->
    <section id="territorios" class="section">
      <h2>Territorios</h2>

      <div class="card">
        <div class="card-header">Mapa general</div>
        <p>M√°s adelante pod√©s cargar el mapa y hacer detecci√≥n por color. Por ahora es solo informativo.</p>
        <p style="font-size:13px;color:#555;">Funci√≥n en construcci√≥n.</p>
      </div>
    </section>

    <!-- üë• INTERESADOS -->
    <section id="interesados" class="section">
      <h2>Interesados</h2>

      <div class="card">
        <div class="card-header">Nuevo interesado</div>

        <div class="field-group">
          <label for="int-nombre">Nombre</label>
          <input type="text" id="int-nombre" placeholder="Ej: Juan P√©rez" />
        </div>

        <div class="field-group">
          <label for="int-direccion">Direcci√≥n</label>
          <input type="text" id="int-direccion" placeholder="Ej: Av. Siempre Viva 123" />
        </div>

        <div class="field-group">
          <label for="int-nota">Observaci√≥n</label>
          <textarea id="int-nota" placeholder="Ej: Prefiere visitas por la tarde."></textarea>
        </div>

        <button id="btn-guardar-interesado">Guardar interesado</button>
        <div id="estado-interesado" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>

      <div class="card">
        <div class="card-header">Listado de interesados</div>
        <div id="lista-interesados" style="margin-top:8px;font-size:13px;color:#555;">
          Todav√≠a no agregaste interesados.
        </div>
      </div>
    </section>

    <!-- ‚è±Ô∏è INFORME -->
    <section id="informe" class="section">
      <h2>Mi Informe</h2>

      <div class="card">
        <div class="card-header">Metas</div>

        <div class="field-group">
          <label for="meta-mensual">Meta de horas mensual</label>
          <input type="number" id="meta-mensual" min="0" step="0.25" placeholder="Ej: 30" />
        </div>

        <div class="field-group">
          <label for="meta-anual">Meta de horas anual (septiembre a agosto)</label>
          <input type="number" id="meta-anual" min="0" step="0.25" placeholder="Ej: 360" />
        </div>

        <button id="btn-guardar-metas">Guardar metas</button>
        <div id="estado-metas" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>

      <div class="card">
        <div class="card-header">Registro diario</div>

        <div class="field-group">
          <label for="reg-fecha">Fecha</label>
          <input type="date" id="reg-fecha" />
        </div>

        <div class="field-group">
          <label for="reg-horas">Horas</label>
          <input type="number" id="reg-horas" min="0" step="0.25" placeholder="Ej: 2.5" />
        </div>

        <button id="btn-agregar-registro">Agregar registro</button>
        <div id="estado-registro" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>

      <div class="card">
        <div class="card-header">Resumen mensual (mes actual)</div>
        <div id="resumen-mensual-detalle" style="font-size:13px;color:#555;">
          Todav√≠a no hay registros.
        </div>
      </div>

      <div class="card">
        <div class="card-header">Resumen anual (a√±o de servicio)</div>
        <div id="resumen-anual-detalle" style="font-size:13px;color:#555;">
          Todav√≠a no hay registros.
        </div>
      </div>
    </section>
  </main>

  <!-- MEN√ö INFERIOR -->
  <nav>
    <div class="nav-btn active" data-section="inicio">
      <span>üè†</span>Inicio
    </div>
    <div class="nav-btn" data-section="salidas">
      <span>üìÖ</span>Salidas
    </div>
    <div class="nav-btn" data-section="territorios">
      <span>üó∫Ô∏è</span>Territorios
    </div>
    <div class="nav-btn" data-section="interesados">
      <span>üë•</span>Interesados
    </div>
    <div class="nav-btn" data-section="informe">
      <span>‚è±Ô∏è</span>Informe
    </div>
  </nav>

  <script>
    console.log("Territorios App v2 READY");

    const diasSemana = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

    // --- Navegaci√≥n entre secciones ---
    const sections = document.querySelectorAll(".section");
    const navButtons = document.querySelectorAll(".nav-btn");

    function mostrarSeccion(id) {
      sections.forEach((sec) => {
        sec.classList.toggle("active", sec.id === id);
      });
      navButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.section === id);
      });
    }

    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.section;
        mostrarSeccion(id);
      });
    });

    // --- SALIDAS: programa semanal de territorios ---
    function obtenerProgramaGuardado() {
      const guardado = localStorage.getItem("territorios_programaSemanal");
      if (!guardado) return {};
      try {
        return JSON.parse(guardado) || {};
      } catch (e) {
        return {};
      }
    }

    function rellenarProgramaEnInputs() {
      const programa = obtenerProgramaGuardado();
      diasSemana.forEach((_, idx) => {
        const input = document.getElementById("territorio-dia-" + idx);
        if (input && programa[idx] !== undefined) {
          input.value = programa[idx];
        }
      });
    }

    function actualizarSalidaHoy(programaOpcional) {
      const salidaElem = document.getElementById("salida-hoy-texto");
      if (!salidaElem) return;

      let programa = programaOpcional;
      if (!programa) {
        programa = obtenerProgramaGuardado();
      }

      const hoy = new Date();
      const idx = hoy.getDay(); // 0=Domingo ... 6=S√°bado
      const valor = programa && programa[idx] ? String(programa[idx]).trim() : "";

      if (valor) {
        salidaElem.textContent = "Hoy te toca el territorio: " + valor;
      } else {
        salidaElem.textContent = "Todav√≠a no cargaste territorio para hoy.";
      }
    }

    const btnGuardarPrograma = document.getElementById("btn-guardar-programa");
    const estadoPrograma = document.getElementById("estado-programa");

    if (btnGuardarPrograma) {
      btnGuardarPrograma.addEventListener("click", () => {
        const programa = {};
        diasSemana.forEach((_, idx) => {
          const input = document.getElementById("territorio-dia-" + idx);
          programa[idx] = input ? input.value.trim() : "";
        });
        localStorage.setItem("territorios_programaSemanal", JSON.stringify(programa));
        if (estadoPrograma) {
          estadoPrograma.textContent = "Programa semanal guardado.";
        }
        actualizarSalidaHoy(programa);
      });
    }

    // --- INTERESADOS ---
    let listaInteresadosData = [];
    const contenedorInteresados = document.getElementById("lista-interesados");
    const estadoInteresado = document.getElementById("estado-interesado");

    function cargarInteresadosDesdeStorage() {
      const guardado = localStorage.getItem("interesados_lista");
      if (!guardado) {
        listaInteresadosData = [];
        return;
      }
      try {
        listaInteresadosData = JSON.parse(guardado) || [];
      } catch (e) {
        listaInteresadosData = [];
      }
    }

    function guardarInteresadosEnStorage() {
      localStorage.setItem("interesados_lista", JSON.stringify(listaInteresadosData));
    }

    function renderInteresados() {
      if (!contenedorInteresados) return;
      if (!listaInteresadosData.length) {
        contenedorInteresados.textContent = "Todav√≠a no agregaste interesados.";
        return;
      }

      contenedorInteresados.innerHTML = "";
      listaInteresadosData.forEach((item) => {
        const card = document.createElement("div");
        card.style.border = "1px solid #e0e3ef";
        card.style.borderRadius = "8px";
        card.style.padding = "8px";
        card.style.marginBottom = "6px";
        card.style.background = "#f9f9fd";

        const nombre = document.createElement("div");
        nombre.style.fontWeight = "600";
        nombre.textContent = item.nombre || "(Sin nombre)";

        const dir = document.createElement("div");
        dir.style.fontSize = "13px";
        dir.textContent = item.direccion || "";

        const nota = document.createElement("div");
        nota.style.fontSize = "12px";
        nota.style.color = "#555";
        nota.textContent = item.nota || "";

        card.appendChild(nombre);
        if (item.direccion) card.appendChild(dir);
        if (item.nota) card.appendChild(nota);

        contenedorInteresados.appendChild(card);
      });
    }

    const btnGuardarInteresado = document.getElementById("btn-guardar-interesado");

    if (btnGuardarInteresado) {
      btnGuardarInteresado.addEventListener("click", () => {
        const nombreEl = document.getElementById("int-nombre");
        const dirEl = document.getElementById("int-direccion");
        const notaEl = document.getElementById("int-nota");

        const nombre = nombreEl ? nombreEl.value.trim() : "";
        const direccion = dirEl ? dirEl.value.trim() : "";
        const nota = notaEl ? notaEl.value.trim() : "";

        if (!nombre && !direccion && !nota) {
          if (estadoInteresado) {
            estadoInteresado.textContent = "Carg√° al menos un dato para guardar.";
          }
          return;
        }

        listaInteresadosData.push({ nombre, direccion, nota });
        guardarInteresadosEnStorage();
        renderInteresados();

        if (estadoInteresado) {
          estadoInteresado.textContent = "Interesado guardado.";
        }
        if (nombreEl) nombreEl.value = "";
        if (dirEl) dirEl.value = "";
        if (notaEl) notaEl.value = "";
      });
    }

    // --- INFORME: metas y horas ---
    let metas = { metaMensual: 0, metaAnual: 0 };
    let registrosHoras = [];

    const metaMensualInput = document.getElementById("meta-mensual");
    const metaAnualInput = document.getElementById("meta-anual");
    const estadoMetas = document.getElementById("estado-metas");

    const regFechaInput = document.getElementById("reg-fecha");
    const regHorasInput = document.getElementById("reg-horas");
    const estadoRegistro = document.getElementById("estado-registro");

    const resumenMensualDetalle = document.getElementById("resumen-mensual-detalle");
    const resumenAnualDetalle = document.getElementById("resumen-anual-detalle");

    function hoyISO() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, "0");
      const d = String(hoy.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }

    function cargarMetasYRegistrosDesdeStorage() {
      const metasGuardadas = localStorage.getItem("informe_metas");
      if (metasGuardadas) {
        try {
          const obj = JSON.parse(metasGuardadas);
          metas.metaMensual = parseFloat(obj.metaMensual) || 0;
          metas.metaAnual = parseFloat(obj.metaAnual) || 0;
        } catch (e) {}
      }

      const regsGuardados = localStorage.getItem("informe_registrosHoras");
      if (regsGuardados) {
        try {
          registrosHoras = JSON.parse(regsGuardados) || [];
        } catch (e) {
          registrosHoras = [];
        }
      }

      if (metaMensualInput) metaMensualInput.value = metas.metaMensual || "";
      if (metaAnualInput) metaAnualInput.value = metas.metaAnual || "";
      if (regFechaInput && !regFechaInput.value) regFechaInput.value = hoyISO();
    }

    function guardarMetasEnStorage() {
      localStorage.setItem("informe_metas", JSON.stringify(metas));
    }

    function guardarRegistrosEnStorage() {
      localStorage.setItem("informe_registrosHoras", JSON.stringify(registrosHoras));
    }

    function actualizarResumenes() {
      const ahora = new Date();
      const mesActual = ahora.getMonth(); // 0-11
      const anioActual = ahora.getFullYear();

      // Total mensual (mes calendario actual)
      let totalMensual = 0;
      registrosHoras.forEach((reg) => {
        if (!reg.fecha) return;
        const fecha = new Date(reg.fecha + "T00:00:00");
        if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
          totalMensual += Number(reg.horas) || 0;
        }
      });

      // A√±o de servicio: septiembre a agosto
      let anioServicioInicio;
      if (mesActual >= 8) {
        // Septiembre (8) a diciembre
        anioServicioInicio = anioActual;
      } else {
        anioServicioInicio = anioActual - 1;
      }
      const inicioServicio = new Date(anioServicioInicio, 8, 1); // 1 sept
      const finServicio = new Date(anioServicioInicio + 1, 8, 1); // 1 sept a√±o siguiente

      let totalAnual = 0;
      registrosHoras.forEach((reg) => {
        if (!reg.fecha) return;
        const fecha = new Date(reg.fecha + "T00:00:00");
        if (fecha >= inicioServicio && fecha < finServicio) {
          totalAnual += Number(reg.horas) || 0;
        }
      });

      const metaMensual = metas.metaMensual || 0;
      const metaAnual = metas.metaAnual || 0;

      const faltanteMensual = Math.max(0, metaMensual - totalMensual);
      const faltanteAnual = Math.max(0, metaAnual - totalAnual);

      if (resumenMensualDetalle) {
        if (!metaMensual && !totalMensual) {
          resumenMensualDetalle.textContent = "No cargaste metas ni registros para este mes.";
        } else {
          resumenMensualDetalle.innerHTML =
            "Meta mensual: <strong>" + metaMensual.toFixed(2) + " h</strong><br>" +
            "Horas registradas este mes: <strong>" + totalMensual.toFixed(2) + " h</strong><br>" +
            "Faltan para la meta: <strong>" + faltanteMensual.toFixed(2) + " h</strong>";
        }
      }

      if (resumenAnualDetalle) {
        const anioFinServicio = anioServicioInicio + 1;
        const textoRango =
          "A√±o de servicio: septiembre " +
          anioServicioInicio +
          " a agosto " +
          anioFinServicio;

        if (!metaAnual && !totalAnual) {
          resumenAnualDetalle.textContent = textoRango + ". Todav√≠a no cargaste metas ni registros.";
        } else {
          resumenAnualDetalle.innerHTML =
            textoRango + "<br>" +
            "Meta anual: <strong>" + metaAnual.toFixed(2) + " h</strong><br>" +
            "Horas registradas en el a√±o de servicio: <strong>" + totalAnual.toFixed(2) + " h</strong><br>" +
            "Faltan para la meta: <strong>" + faltanteAnual.toFixed(2) + " h</strong>";
        }
      }
    }

    const btnGuardarMetas = document.getElementById("btn-guardar-metas");
    if (btnGuardarMetas) {
      btnGuardarMetas.addEventListener("click", () => {
        const mensual = metaMensualInput ? parseFloat(metaMensualInput.value) : 0;
        const anual = metaAnualInput ? parseFloat(metaAnualInput.value) : 0;
        metas.metaMensual = isNaN(mensual) ? 0 : mensual;
        metas.metaAnual = isNaN(anual) ? 0 : anual;
        guardarMetasEnStorage();
        if (estadoMetas) {
          estadoMetas.textContent = "Metas guardadas.";
        }
        actualizarResumenes();
      });
    }

    const btnAgregarRegistro = document.getElementById("btn-agregar-registro");
    if (btnAgregarRegistro) {
      btnAgregarRegistro.addEventListener("click", () => {
        const fecha = regFechaInput ? regFechaInput.value : "";
        const horas = regHorasInput ? parseFloat(regHorasInput.value) : 0;

        if (!fecha || isNaN(horas) || horas <= 0) {
          if (estadoRegistro) {
            estadoRegistro.textContent = "Carg√° una fecha y horas v√°lidas.";
          }
          return;
        }

        registrosHoras.push({ fecha, horas });
        guardarRegistrosEnStorage();
        if (estadoRegistro) {
          estadoRegistro.textContent = "Registro agregado.";
        }
        if (regHorasInput) regHorasInput.value = "";
        actualizarResumenes();
      });
    }

    // --- Inicializaci√≥n al cargar la app ---
    rellenarProgramaEnInputs();
    actualizarSalidaHoy();

    cargarInteresadosDesdeStorage();
    renderInteresados();

    cargarMetasYRegistrosDesdeStorage();
    actualizarResumenes();
  </script>
</body>
</html>

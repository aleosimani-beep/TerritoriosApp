<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TerritoriosApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
      background: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      background: radial-gradient(circle at top, #eef2ff 0, #e5e7eb 40%, #d1d5db 100%);
    }
    .app {
      background: #f9fafb;
      margin: 0.75rem;
      margin-bottom: 3.5rem;
      border-radius: 1rem;
      max-width: 960px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      padding: 0.9rem 1.1rem;
      background: linear-gradient(135deg,#2563eb,#4f46e5);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.25rem;
    }
    header .subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .badge {
      background: rgba(15,23,42,0.25);
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      font-size: 0.75rem;
    }

    main {
      padding: 1rem 1.1rem 0.5rem 1.1rem;
      flex: 1;
      overflow-y: auto;
      box-sizing: border-box;
    }

    h2 {
      font-size: 1.1rem;
      margin: 0 0 0.6rem 0;
      color: #111827;
    }
    h3 {
      font-size: 0.95rem;
      margin: 0.7rem 0 0.4rem 0;
      color: #111827;
    }
    p {
      margin: 0.3rem 0;
    }
    .small-text {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .card {
      background: #ffffff;
      border-radius: 0.9rem;
      padding: 0.8rem 0.9rem;
      margin-bottom: 0.9rem;
      border: 1px solid #e5e7eb;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .chip {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.75rem;
      color: #374151;
    }

    label {
      font-size: 0.78rem;
      display: block;
      margin-bottom: 0.15rem;
      color: #374151;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 0.85rem;
      padding: 0.45rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      margin-bottom: 0.45rem;
    }
    input:focus,
    textarea:focus {
      outline: 2px solid #2563eb33;
      border-color: #2563eb;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
      font-weight: 600;
    }
    button:active {
      transform: scale(0.97);
    }
    .btn-secondary {
      background: #6b7280;
      color: #f9fafb;
    }
    .btn-danger {
      background: #dc2626;
    }
    .btn-small {
      font-size: 0.75rem;
      padding: 0.25rem 0.55rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.3rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.25rem 0.3rem;
      text-align: left;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .resumen-linea {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    .resumen-destacado {
      background: #eef2ff;
      border-radius: 0.7rem;
      padding: 0.55rem 0.7rem;
      margin-bottom: 0.4rem;
    }

    .status-ok {
      color: #16a34a;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }
    .status-error {
      color: #b91c1c;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }

    .salidas-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 0.3rem;
      align-items: flex-start;
      margin-top: 0.2rem;
    }
    .salidas-grid-header div {
      font-size: 0.78rem;
      font-weight: 600;
      color: #374151;
    }
    .mini-label {
      font-size: 0.7rem;
      color: #6b7280;
      margin-bottom: 0.1rem;
    }
    .bloque-periodo {
      border-radius: 0.6rem;
      border: 1px solid #e5e7eb;
      padding: 0.35rem 0.4rem;
      background: #f9fafb;
      box-sizing: border-box;
    }
    .bloque-periodo input[type="text"],
    .bloque-periodo input[type="time"] {
      margin-bottom: 0.25rem;
      font-size: 0.8rem;
      padding: 0.3rem 0.4rem;
    }

    .territorio-color-preview {
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      margin-left: 0.35rem;
    }
    .fila-territorio {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .flex-row {
      display: flex;
      gap: 0.5rem;
    }
    .flex-1 {
      flex: 1;
    }

    .interesado-card {
      border-radius: 0.7rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.7rem;
      margin-top: 0.3rem;
      background: #ffffff;
    }
    .interesado-nombre {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }
    .interesado-detalle {
      font-size: 0.75rem;
      color: #4b5563;
    }

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.25rem 0;
      font-size: 0.75rem;
      z-index: 20;
    }
    .bottom-nav button {
      background: transparent;
      border-radius: 0;
      border: none;
      color: #9ca3af;
      font-weight: 400;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.05rem;
      padding: 0.2rem 0.5rem;
    }
    .bottom-nav button span.icon {
      font-size: 1.1rem;
      line-height: 1;
    }
    .bottom-nav button.active {
      color: #f9fafb;
      border-top: 2px solid #22c55e;
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    @media (min-width: 900px) {
      .bottom-nav {
        max-width: 960px;
        margin: 0 auto;
        border-radius: 999px 999px 0 0;
      }
    }

    .mapa-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .mapa-modal img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .mapa-modal button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>TerritoriosApp</h1>
        <div class="subtitle">Salidas, territorios, interesados e informe personal</div>
      </div>
      <div class="badge">v1 ¬∑ localStorage</div>
    </header>

    <main>
      <!-- INICIO -->
      <section id="sec-inicio" class="section active">
        <div class="card">
          <div class="card-header">
            <h2>Salidas de hoy</h2>
            <span class="chip" id="chip-fecha-hoy"></span>
          </div>
          <div id="bloque-salidas-hoy">
            <p class="small-text">Cargando programa semanal...</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Atajos r√°pidos</h2>
          </div>
          <div class="flex-row">
            <button class="flex-1" onclick="cambiarSeccion('salidas')">üìÖ Editar salidas</button>
            <button class="flex-1 btn-secondary" onclick="cambiarSeccion('informe')">‚è±Ô∏è Registrar horas</button>
          </div>
          <p class="small-text" style="margin-top:0.5rem;">
            Todo se guarda autom√°ticamente en este dispositivo. Si borr√°s el historial o los datos del navegador, se pierde.
          </p>
        </div>
      </section>

      <!-- SALIDAS -->
      <section id="sec-salidas" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Programa semanal de salidas</h2>
            <span class="chip">Encuentros ma√±ana / tarde</span>
          </div>
          <p class="small-text">
            Defin√≠ para cada d√≠a el encuentro, hora, conductor y mapa de las salidas de ma√±ana y tarde.
          </p>

          <label for="salidas-mes">Mes del programa</label>
          <input id="salidas-mes" type="month" onchange="cambiarMesSalidas()" />

          <div class="salidas-grid salidas-grid-header" style="margin-top:0.6rem;">
            <div>D√≠a</div>
            <div>Ma√±ana</div>
            <div>Tarde</div>
          </div>
          <div id="contenedor-salidas-semana"></div>

          <button style="margin-top:0.6rem;" onclick="guardarSalidasSemana()">
            Guardar programa semanal
          </button>
          <div id="status-salidas" class="status-ok" style="display:none;"></div>
        </div>
      </section>

      <!-- TERRITORIOS -->
      <section id="sec-territorios" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Territorios</h2>
            <span class="chip" id="chip-total-territorios">0 registrados</span>
          </div>
          <p class="small-text">
            Pod√©s usar el color como referencia visual: verde = trabajado, amarillo = por hacer, rojo = pendiente.
          </p>

          <h3>Mapa general</h3>
          <label for="input-mapa">Subir imagen del mapa general</label>
          <input id="input-mapa" type="file" accept="image/*" onchange="subirMapaGeneral(event)" />
          <div id="mapa-preview-wrapper" style="margin-top:0.4rem; display:none;">
            <img id="mapa-preview" alt="Mapa general" style="max-width:100%; border-radius:0.5rem; border:1px solid #d1d5db; cursor:pointer;" onclick="abrirMapaAmpliado()" />
            <p class="small-text">Toc√° la imagen para verla ampliada.</p>
          </div>

          <h3 style="margin-top:0.9rem;">Nuevo territorio</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="territorio-nombre">Nombre / n√∫mero</label>
              <input id="territorio-nombre" type="text" placeholder="Territorio 12 - Centro" />
            </div>
            <div style="width:110px;">
              <label for="territorio-color">Color</label>
              <div class="fila-territorio">
                <input id="territorio-color" type="color" value="#22c55e" />
                <div class="territorio-color-preview" id="territorio-color-preview"></div>
              </div>
            </div>
          </div>
          <label for="territorio-notas">Notas</label>
          <textarea id="territorio-notas" placeholder="Referencias, zonas especiales, etc."></textarea>

          <button onclick="agregarTerritorio()">Agregar territorio</button>
          <div id="status-territorio" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Lista de territorios</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>Territorio</th>
                <th>Notas</th>
                <th>Color</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla-territorios"></tbody>
          </table>
          <p id="msg-sin-territorios" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste territorios.
          </p>
        </div>
      </section>

      <!-- INTERESADOS -->
      <section id="sec-interesados" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Interesados</h2>
            <span class="chip" id="chip-total-interesados">0 contactos</span>
          </div>

          <h3>Nuevo interesado</h3>
          <label for="int-nombre">Nombre</label>
          <input id="int-nombre" type="text" placeholder="Nombre y apellido" />

          <label for="int-direccion">Direcci√≥n / referencia</label>
          <input id="int-direccion" type="text" placeholder="Calle, n√∫mero, barrio..." />

          <div class="flex-row">
            <div class="flex-1">
              <label for="int-telefono">Tel√©fono</label>
              <input id="int-telefono" type="text" placeholder="Ej: 351-1234567" />
            </div>
            <div class="flex-1">
              <label for="int-territorio">Territorio</label>
              <input id="int-territorio" type="text" placeholder="Ej: T-12" />
            </div>
          </div>

          <label for="int-notas">Notas</label>
          <textarea id="int-notas" placeholder="Cu√°ndo se visit√≥, publicaciones, comentarios, etc."></textarea>

          <button onclick="agregarInteresado()">Agregar interesado</button>
          <div id="status-interesado" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Listado y b√∫squeda</h3>
          </div>
          <label for="buscador-interesados">Buscar por nombre, direcci√≥n o territorio</label>
          <input id="buscador-interesados" type="text" placeholder="Escrib√≠ para filtrar..." oninput="renderInteresados()" />

          <div id="lista-interesados"></div>
          <p id="msg-sin-interesados" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste interesados.
          </p>
        </div>
      </section>

      <!-- INFORME -->
      <section id="sec-informe" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Mi informe</h2>
            <span class="chip" id="chip-mes-informe"></span>
          </div>
          <h3>Metas</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="meta-horas">Horas meta (mes actual)</label>
              <input id="meta-horas" type="number" min="0" step="0.5" />
            </div>
            <div class="flex-1">
              <label for="meta-anual">Meta anual (septiembre‚Äìagosto)</label>
              <input id="meta-anual" type="number" min="0" step="1" />
            </div>
          </div>
          <button onclick="guardarMetas()">Guardar metas</button>
          <div id="status-meta" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <h3>Registro diario</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="reg-fecha">Fecha</label>
              <input id="reg-fecha" type="date" />
            </div>
            <div style="width:110px;">
              <label for="reg-horas">Horas</label>
              <input id="reg-horas" type="number" min="0" step="0.25" />
            </div>
            <div style="width:110px;">
              <label for="reg-cursos">Cursos</label>
              <input id="reg-cursos" type="number" min="0" step="1" />
            </div>
          </div>

          <button onclick="agregarRegistroDiario()">Agregar al registro</button>
          <div id="status-registro" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <h3>Resumen del mes</h3>
          <div id="resumen-mes"></div>
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Horas</th>
                <th>Cursos</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla-registro-diario"></tbody>
          </table>
          <p id="msg-sin-registro" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste registros para este mes.
          </p>
        </div>
      </section>
    </main>
  </div>

  <!-- NAV inferior -->
  <div class="bottom-nav">
    <button id="nav-inicio" class="active" onclick="cambiarSeccion('inicio')">
      <span class="icon">üè†</span>
      Inicio
    </button>
    <button id="nav-salidas" onclick="cambiarSeccion('salidas')">
      <span class="icon">üìÖ</span>
      Salidas
    </button>
    <button id="nav-territorios" onclick="cambiarSeccion('territorios')">
      <span class="icon">üó∫Ô∏è</span>
      Territorios
    </button>
    <button id="nav-interesados" onclick="cambiarSeccion('interesados')">
      <span class="icon">üë•</span>
      Interesados
    </button>
    <button id="nav-informe" onclick="cambiarSeccion('informe')">
      <span class="icon">‚è±Ô∏è</span>
      Informe
    </button>
  </div>

  <!-- Modal mapa ampliado -->
  <div id="mapa-modal" class="mapa-modal" onclick="cerrarMapaAmpliado(event)">
    <img id="mapa-modal-img" alt="Mapa general ampliado" />
    <button type="button" onclick="cerrarMapaAmpliado(event)">Cerrar ‚úï</button>
  </div>

  <script>
    // ==== Navegaci√≥n b√°sica (asegura que los botones anden) ====
    function cambiarSeccion(id) {
      var sections = ['inicio','salidas','territorios','interesados','informe'];
      for (var i = 0; i < sections.length; i++) {
        var sec = sections[i];
        var secEl = document.getElementById('sec-' + sec);
        var navEl = document.getElementById('nav-' + sec);
        if (sec === id) {
          if (secEl) secEl.classList.add('active');
          if (navEl) navEl.classList.add('active');
        } else {
          if (secEl) secEl.classList.remove('active');
          if (navEl) navEl.classList.remove('active');
        }
      }
      if (id === 'informe') {
        actualizarResumenInforme();
      }
    }

    // ==== Constantes / helpers ====
    const LS_SALIDAS = "territorios_salidasSemana";
    const LS_SALIDAS_MES = "territorios_salidasMes";
    const LS_TERRITORIOS = "territorios_lista";
    const LS_INTERESADOS = "territorios_interesados";
    const LS_META_HORAS = "territorios_metaHoras";
    const LS_META_ANUAL = "territorios_metaAnual";
    const LS_REGISTRO = "territorios_registroDiario";
    const LS_MAPA_GENERAL = "territorios_mapaGeneral";

    // Semana jueves‚Äìmi√©rcoles
    const DIAS = [
      "Jueves","Viernes","S√°bado","Domingo","Lunes","Martes","Mi√©rcoles"
    ];

    function hoyISO() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function mesActualClave() {
      return hoyISO().slice(0,7); // YYYY-MM
    }

    function serviceYearKeyFromDate(dateStr) {
      if (!dateStr) return "";
      const partes = dateStr.split("-");
      if (partes.length < 2) return "";
      const year = parseInt(partes[0],10);
      const month = parseInt(partes[1],10);
      if (isNaN(year) || isNaN(month)) return "";
      const startYear = (month >= 9) ? year : year - 1;
      const endYear = startYear + 1;
      return startYear + "-" + endYear;
    }

    function currentServiceYearKey() {
      return serviceYearKeyFromDate(hoyISO());
    }

    function mostrarStatus(id, msg, ok) {
      if (ok === undefined) ok = true;
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = msg;
      el.style.display = "block";
      el.className = ok ? "status-ok" : "status-error";
      setTimeout(function() {
        el.style.display = "none";
      }, 1500);
    }

    // ==== Salidas de semana (jueves‚Äìmi√©rcoles) ====
    function cargarSalidasSemana() {
      const dataStr = localStorage.getItem(LS_SALIDAS);
      let salidasGuardadas = [];
      if (dataStr) {
        try {
          salidasGuardadas = JSON.parse(dataStr);
        } catch (e) {}
      }
      if (!Array.isArray(salidasGuardadas) || salidasGuardadas.length !== 7) {
        return DIAS.map(function(d) {
          return {
            dia: d,
            mananaAct: "",
            mananaHora: "",
            mananaConductor: "",
            mananaMapa: "",
            tardeAct: "",
            tardeHora: "",
            tardeConductor: "",
            tardeMapa: ""
          };
        });
      }
      return DIAS.map(function(d, idx) {
        const fila = salidasGuardadas[idx] || {};
        return {
          dia: d,
          mananaAct: (fila.mananaAct !== undefined) ? fila.mananaAct : (fila.manana || ""),
          mananaHora: fila.mananaHora || "",
          mananaConductor: fila.mananaConductor || "",
          mananaMapa: fila.mananaMapa || "",
          tardeAct: (fila.tardeAct !== undefined) ? fila.tardeAct : (fila.tarde || ""),
          tardeHora: fila.tardeHora || "",
          tardeConductor: fila.tardeConductor || "",
          tardeMapa: fila.tardeMapa || ""
        };
      });
    }

    function obtenerFechasSemanaMes(mesStr) {
      if (!mesStr) return [ "", "", "", "", "", "", "" ];
      const partes = mesStr.split("-");
      if (partes.length !== 2) return [ "", "", "", "", "", "", "" ];
      const year = parseInt(partes[0],10);
      const month = parseInt(partes[1],10);
      if (isNaN(year) || isNaN(month)) return [ "", "", "", "", "", "", "" ];

      const firstDay = new Date(year, month-1, 1);
      const firstDayDow = firstDay.getDay(); // 0=Dom,...,4=Jue
      const offsetToThursday = (4 - firstDayDow + 7) % 7;
      const firstThursdayDate = 1 + offsetToThursday;

      const fechas = [];
      for (var i = 0; i < 7; i++) {
        const d = new Date(year, month-1, firstThursdayDate + i);
        fechas.push(d.getDate());
      }
      return fechas;
    }

    function renderSalidasSemana() {
      const cont = document.getElementById("contenedor-salidas-semana");
      if (!cont) return;
      cont.innerHTML = "";
      const salidas = cargarSalidasSemana();
      const mesGuardado = localStorage.getItem(LS_SALIDAS_MES) || mesActualClave();
      const fechas = obtenerFechasSemanaMes(mesGuardado);

      salidas.forEach(function(fila, idx) {
        const row = document.createElement("div");
        row.className = "salidas-grid";
        const numeroDia = fechas[idx] || "";
        const etiquetaDia = numeroDia ? (fila.dia + " " + numeroDia) : fila.dia;

        row.innerHTML =
          '<div class="small-text">' + etiquetaDia + '</div>' +
          '<div class="bloque-periodo">' +
            '<div class="mini-label">Encuentro</div>' +
            '<input type="text" id="manana-act-' + idx + '" value="' + (fila.mananaAct || "") + '" placeholder="Ej: Encuentro 1" />' +
            '<div class="flex-row">' +
              '<div class="flex-1">' +
                '<div class="mini-label">Hora</div>' +
                '<input type="time" id="manana-hora-' + idx + '" value="' + (fila.mananaHora || "") + '" />' +
              '</div>' +
              '<div class="flex-1">' +
                '<div class="mini-label">Conductor</div>' +
                '<input type="text" id="manana-cond-' + idx + '" value="' + (fila.mananaConductor || "") + '" />' +
              '</div>' +
            '</div>' +
            '<div class="mini-label">Mapa / punto de encuentro</div>' +
            '<input type="text" id="manana-mapa-' + idx + '" value="' + (fila.mananaMapa || "") + '" placeholder="Ej: Plaza X, Mapa 3" />' +
          '</div>' +
          '<div class="bloque-periodo">' +
            '<div class="mini-label">Encuentro</div>' +
            '<input type="text" id="tarde-act-' + idx + '" value="' + (fila.tardeAct || "") + '" placeholder="Ej: Encuentro 2" />' +
            '<div class="flex-row">' +
              '<div class="flex-1">' +
                '<div class="mini-label">Hora</div>' +
                '<input type="time" id="tarde-hora-' + idx + '" value="' + (fila.tardeHora || "") + '" />' +
              '</div>' +
              '<div class="flex-1">' +
                '<div class="mini-label">Conductor</div>' +
                '<input type="text" id="tarde-cond-' + idx + '" value="' + (fila.tardeConductor || "") + '" />' +
              '</div>' +
            '</div>' +
            '<div class="mini-label">Mapa / punto de encuentro</div>' +
            '<input type="text" id="tarde-mapa-' + idx + '" value="' + (fila.tardeMapa || "") + '" placeholder="Ej: Plaza Y, Mapa 4" />' +
          '</div>';
        cont.appendChild(row);
      });
    }

    function guardarSalidasSemana() {
      const salidas = DIAS.map(function(dia, idx) {
        return {
          dia: dia,
          mananaAct: (document.getElementById("manana-act-" + idx) || {}).value || "",
          mananaHora: (document.getElementById("manana-hora-" + idx) || {}).value || "",
          mananaConductor: (document.getElementById("manana-cond-" + idx) || {}).value || "",
          mananaMapa: (document.getElementById("manana-mapa-" + idx) || {}).value || "",
          tardeAct: (document.getElementById("tarde-act-" + idx) || {}).value || "",
          tardeHora: (document.getElementById("tarde-hora-" + idx) || {}).value || "",
          tardeConductor: (document.getElementById("tarde-cond-" + idx) || {}).value || "",
          tardeMapa: (document.getElementById("tarde-mapa-" + idx) || {}).value || ""
        };
      });
      localStorage.setItem(LS_SALIDAS, JSON.stringify(salidas));
      mostrarStatus("status-salidas","Programa guardado ‚úÖ",true);
      renderSalidasHoy();
    }

    function cambiarMesSalidas() {
      const inp = document.getElementById("salidas-mes");
      if (!inp) return;
      const val = inp.value;
      if (!val) return;
      localStorage.setItem(LS_SALIDAS_MES, val);
      renderSalidasSemana();
    }

    function renderSalidasHoy() {
      const chip = document.getElementById("chip-fecha-hoy");
      const cont = document.getElementById("bloque-salidas-hoy");
      if (!chip || !cont) return;

      const hoy = new Date();
      // Jueves=4 => 0, ..., Mi√©rcoles=3 => 6
      const diaIndex = (hoy.getDay() + 3) % 7;
      const fechaStr = hoy.toLocaleDateString("es-AR", {
        weekday: "long",
        day: "numeric",
        month: "long"
      });
      chip.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);

      const salidas = cargarSalidasSemana();
      const hoyFila = salidas[diaIndex];

      if (!hoyFila) {
        cont.innerHTML = '<p class="small-text">Para hoy no hay salidas configuradas en el programa semanal.</p>';
        return;
      }

      let html = "";
      const tieneManana = hoyFila.mananaAct || hoyFila.mananaHora || hoyFila.mananaMapa || hoyFila.mananaConductor;
      const tieneTarde = hoyFila.tardeAct || hoyFila.tardeHora || hoyFila.tardeMapa || hoyFila.tardeConductor;

      if (!tieneManana && !tieneTarde) {
        cont.innerHTML = '<p class="small-text">Para hoy no hay salidas configuradas en el programa semanal.</p>';
        return;
      }

      if (tieneManana) {
        html += '<p><strong>Ma√±ana:</strong> ' + (hoyFila.mananaHora || "") + ' ' + (hoyFila.mananaAct || "") + '</p>';
        const det = [];
        if (hoyFila.mananaConductor) det.push("Conductor: " + hoyFila.mananaConductor);
        if (hoyFila.mananaMapa) det.push("Mapa: " + hoyFila.mananaMapa);
        if (det.length) {
          html += '<p class="small-text">- ' + det.join(" ¬∑ ") + '</p>';
        }
      }
      if (tieneTarde) {
        html += '<p style="margin-top:0.4rem;"><strong>Tarde:</strong> ' + (hoyFila.tardeHora || "") + ' ' + (hoyFila.tardeAct || "") + '</p>';
        const det2 = [];
        if (hoyFila.tardeConductor) det2.push("Conductor: " + hoyFila.tardeConductor);
        if (hoyFila.tardeMapa) det2.push("Mapa: " + hoyFila.tardeMapa);
        if (det2.length) {
          html += '<p class="small-text">- ' + det2.join(" ¬∑ ") + '</p>';
        }
      }

      cont.innerHTML = html;
    }

    // ==== Territorios ====
    function cargarTerritorios() {
      const dataStr = localStorage.getItem(LS_TERRITORIOS);
      let lista = [];
      if (dataStr) {
        try { lista = JSON.parse(dataStr); } catch(e){}
      }
      if (!Array.isArray(lista)) lista = [];
      return lista;
    }

    function guardarTerritorios(lista) {
      localStorage.setItem(LS_TERRITORIOS, JSON.stringify(lista));
    }

    function renderTerritorios() {
      const lista = cargarTerritorios();
      const tbody = document.getElementById("tabla-territorios");
      const chip = document.getElementById("chip-total-territorios");
      const msgSin = document.getElementById("msg-sin-territorios");
      if (!tbody || !chip || !msgSin) return;

      tbody.innerHTML = "";
      chip.textContent = lista.length + " registrados";

      if (!lista.length) {
        msgSin.style.display = "block";
        return;
      }
      msgSin.style.display = "none";

      lista.forEach(function(t, idx) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td>' + (t.nombre || "") + '</td>' +
          '<td>' + (t.notas || "") + '</td>' +
          '<td>' +
            '<div style="display:flex; align-items:center; gap:0.3rem;">' +
              '<div style="width:16px; height:16px; border-radius:4px; border:1px solid #d1d5db; background:' + (t.color || "#ffffff") + ';"></div>' +
              '<span class="small-text">' + (t.color || "") + '</span>' +
            '</div>' +
          '</td>' +
          '<td><button class="btn-danger btn-small" onclick="eliminarTerritorio(' + idx + ')">‚úï</button></td>';
        tbody.appendChild(tr);
      });
    }

    function agregarTerritorio() {
      const nombreEl = document.getElementById("territorio-nombre");
      const colorEl = document.getElementById("territorio-color");
      const notasEl = document.getElementById("territorio-notas");
      if (!nombreEl || !colorEl || !notasEl) return;

      const nombre = nombreEl.value.trim();
      const color = colorEl.value;
      const notas = notasEl.value.trim();

      if (!nombre) {
        mostrarStatus("status-territorio","Pon√© un nombre o n√∫mero de territorio",false);
        return;
      }

      const lista = cargarTerritorios();
      lista.push({
        id: Date.now(),
        nombre: nombre,
        color: color,
        notas: notas
      });
      guardarTerritorios(lista);
      renderTerritorios();

      nombreEl.value = "";
      notasEl.value = "";
      mostrarStatus("status-territorio","Territorio agregado ‚úÖ",true);
    }

    function eliminarTerritorio(idx) {
      const lista = cargarTerritorios();
      if (idx < 0 || idx >= lista.length) return;
      if (!confirm("¬øEliminar este territorio?")) return;
      lista.splice(idx,1);
      guardarTerritorios(lista);
      renderTerritorios();
    }

    function mostrarMapaPreview(dataUrl) {
      const wrapper = document.getElementById("mapa-preview-wrapper");
      const img = document.getElementById("mapa-preview");
      if (!wrapper || !img) return;
      if (dataUrl) {
        img.src = dataUrl;
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "none";
      }
    }

    function cargarMapaGeneral() {
      const dataUrl = localStorage.getItem(LS_MAPA_GENERAL);
      if (dataUrl) {
        mostrarMapaPreview(dataUrl);
      }
    }

    function subirMapaGeneral(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data

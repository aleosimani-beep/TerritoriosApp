<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Territorios App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #f4f6fb;
      color: #222;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 10px 16px;
      background: #1b4b82;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
    }
    main {
      flex: 1;
      padding: 12px 12px 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    p {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .card {
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 14px;
    }
    .card-header {
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Colores por secci√≥n */
    #inicio .card {
      background: #fff4e0;
    }
    #salidas .card {
      background: #e6f4ff;
    }
    #territorios .card {
      background: #e8fff2;
    }
    #interesados .card {
      background: #f8e8ff;
    }
    #informe .card {
      background: #fff0f5;
    }

    /* Tarjeta destacada de INICIO */
    .card.destacada {
      padding: 18px;
      margin-bottom: 18px;
    }
    .card.destacada .card-header {
      font-size: 16px;
    }
    #salida-hoy-texto {
      font-size: 16px;
      line-height: 1.4;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 14px;
      background: #1b4b82;
      color: white;
      cursor: pointer;
      margin-top: 6px;
    }
    button:active {
      transform: scale(0.98);
    }

    /* Accesos directos en INICIO */
    .shortcut-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .nav-btn {
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #d5d8e3;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      font-size: 13px;
      cursor: pointer;
    }
    .nav-btn span {
      font-size: 20px;
      margin-bottom: 2px;
    }
    .nav-btn strong {
      font-size: 14px;
    }
    .nav-btn.active {
      border-color: #1b4b82;
      box-shadow: 0 0 0 1px rgba(27,75,130,0.3);
    }

    .field-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d4e4;
      font-size: 14px;
      width: 100%;
      background: #f9f9fd;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    /* SALIDAS: d√≠as con men√∫ desplegable */
    .programa-semanal {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }
    details.dia-detalle {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(27,75,130,0.04);
    }
    details.dia-detalle summary {
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      list-style: none;
    }
    details.dia-detalle summary::marker {
      content: "";
    }
    .turno {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #ffffffaa;
      border: 1px solid #dde0f3;
    }
    .turno h4 {
      font-size: 13px;
      margin-bottom: 4px;
    }

    /* Tabs Mi Informe */
    .tabs-informe {
      display: flex;
      gap: 8px;
      margin: 8px 0 10px;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d0a4c5;
      background: #ffe4f2;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #d8347f;
      color: white;
      border-color: #d8347f;
      font-weight: 600;
    }
    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    TERRITORIOS APP
  </header>

  <main>
    <!-- üè† INICIO -->
    <section id="inicio" class="section active">
      <div class="card destacada">
        <div class="card-header">Salida de hoy</div>
        <p id="salida-hoy-texto">Todav√≠a no cargaste el programa semanal.</p>
      </div>

      <div class="shortcut-grid">
        <button class="nav-btn active" data-section="salidas">
          <span>üìÖ</span>
          <strong>Salidas</strong>
          <small>Programa semanal</small>
        </button>
        <button class="nav-btn" data-section="territorios">
          <span>üó∫Ô∏è</span>
          <strong>Territorios</strong>
          <small>Informaci√≥n general</small>
        </button>
        <button class="nav-btn" data-section="interesados">
          <span>üë•</span>
          <strong>Interesados</strong>
          <small>Listado y notas</small>
        </button>
        <button class="nav-btn" data-section="informe">
          <span>‚è±Ô∏è</span>
          <strong>Mi Informe</strong>
          <small>Registros y metas</small>
        </button>
      </div>
    </section>

    <!-- üìÖ SALIDAS -->
    <section id="salidas" class="section">
      <h2>Salidas de semana</h2>

      <div class="card">
        <div class="card-header">Programa semanal (ma√±ana y tarde)</div>
        <p>Para cada d√≠a carg√° hora, lugar, conductor y territorio para <strong>ma√±ana</strong> y <strong>tarde</strong>. Se guarda en este dispositivo.</p>

        <div class="programa-semanal">
          <!-- DOMINGO (0) -->
          <details class="dia-detalle" open>
            <summary>Domingo</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d0-man-hora">Hora</label>
                <input type="text" id="d0-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d0-man-lugar">Lugar</label>
                <input type="text" id="d0-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d0-man-conductor">Conductor</label>
                <input type="text" id="d0-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d0-man-territorio">Territorio</label>
                <input type="text" id="d0-man-territorio" placeholder="Ej: 12" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d0-tar-hora">Hora</label>
                <input type="text" id="d0-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d0-tar-lugar">Lugar</label>
                <input type="text" id="d0-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d0-tar-conductor">Conductor</label>
                <input type="text" id="d0-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d0-tar-territorio">Territorio</label>
                <input type="text" id="d0-tar-territorio" placeholder="Ej: 14" />
              </div>
            </div>
          </details>

          <!-- LUNES (1) -->
          <details class="dia-detalle">
            <summary>Lunes</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d1-man-hora">Hora</label>
                <input type="text" id="d1-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d1-man-lugar">Lugar</label>
                <input type="text" id="d1-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d1-man-conductor">Conductor</label>
                <input type="text" id="d1-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d1-man-territorio">Territorio</label>
                <input type="text" id="d1-man-territorio" placeholder="Ej: 5" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d1-tar-hora">Hora</label>
                <input type="text" id="d1-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d1-tar-lugar">Lugar</label>
                <input type="text" id="d1-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d1-tar-conductor">Conductor</label>
                <input type="text" id="d1-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d1-tar-territorio">Territorio</label>
                <input type="text" id="d1-tar-territorio" placeholder="Ej: 8" />
              </div>
            </div>
          </details>

          <!-- MARTES (2) -->
          <details class="dia-detalle">
            <summary>Martes</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d2-man-hora">Hora</label>
                <input type="text" id="d2-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d2-man-lugar">Lugar</label>
                <input type="text" id="d2-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d2-man-conductor">Conductor</label>
                <input type="text" id="d2-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d2-man-territorio">Territorio</label>
                <input type="text" id="d2-man-territorio" placeholder="Ej: 8" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d2-tar-hora">Hora</label>
                <input type="text" id="d2-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d2-tar-lugar">Lugar</label>
                <input type="text" id="d2-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d2-tar-conductor">Conductor</label>
                <input type="text" id="d2-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d2-tar-territorio">Territorio</label>
                <input type="text" id="d2-tar-territorio" placeholder="Ej: 10" />
              </div>
            </div>
          </details>

          <!-- MI√âRCOLES (3) -->
          <details class="dia-detalle">
            <summary>Mi√©rcoles</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d3-man-hora">Hora</label>
                <input type="text" id="d3-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d3-man-lugar">Lugar</label>
                <input type="text" id="d3-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d3-man-conductor">Conductor</label>
                <input type="text" id="d3-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d3-man-territorio">Territorio</label>
                <input type="text" id="d3-man-territorio" placeholder="Ej: 10" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d3-tar-hora">Hora</label>
                <input type="text" id="d3-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d3-tar-lugar">Lugar</label>
                <input type="text" id="d3-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d3-tar-conductor">Conductor</label>
                <input type="text" id="d3-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d3-tar-territorio">Territorio</label>
                <input type="text" id="d3-tar-territorio" placeholder="Ej: 11" />
              </div>
            </div>
          </details>

          <!-- JUEVES (4) -->
          <details class="dia-detalle">
            <summary>Jueves</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d4-man-hora">Hora</label>
                <input type="text" id="d4-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d4-man-lugar">Lugar</label>
                <input type="text" id="d4-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d4-man-conductor">Conductor</label>
                <input type="text" id="d4-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d4-man-territorio">Territorio</label>
                <input type="text" id="d4-man-territorio" placeholder="Ej: 3" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d4-tar-hora">Hora</label>
                <input type="text" id="d4-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d4-tar-lugar">Lugar</label>
                <input type="text" id="d4-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d4-tar-conductor">Conductor</label>
                <input type="text" id="d4-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d4-tar-territorio">Territorio</label>
                <input type="text" id="d4-tar-territorio" placeholder="Ej: 9" />
              </div>
            </div>
          </details>

          <!-- VIERNES (5) -->
          <details class="dia-detalle">
            <summary>Viernes</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d5-man-hora">Hora</label>
                <input type="text" id="d5-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d5-man-lugar">Lugar</label>
                <input type="text" id="d5-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d5-man-conductor">Conductor</label>
                <input type="text" id="d5-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d5-man-territorio">Territorio</label>
                <input type="text" id="d5-man-territorio" placeholder="Ej: 7" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d5-tar-hora">Hora</label>
                <input type="text" id="d5-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d5-tar-lugar">Lugar</label>
                <input type="text" id="d5-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d5-tar-conductor">Conductor</label>
                <input type="text" id="d5-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d5-tar-territorio">Territorio</label>
                <input type="text" id="d5-tar-territorio" placeholder="Ej: 6" />
              </div>
            </div>
          </details>

          <!-- S√ÅBADO (6) -->
          <details class="dia-detalle">
            <summary>S√°bado</summary>
            <div class="turno">
              <h4>Ma√±ana</h4>
              <div class="field-group">
                <label for="d6-man-hora">Hora</label>
                <input type="text" id="d6-man-hora" placeholder="Ej: 9:30" />
              </div>
              <div class="field-group">
                <label for="d6-man-lugar">Lugar</label>
                <input type="text" id="d6-man-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d6-man-conductor">Conductor</label>
                <input type="text" id="d6-man-conductor" placeholder="Ej: Juan" />
              </div>
              <div class="field-group">
                <label for="d6-man-territorio">Territorio</label>
                <input type="text" id="d6-man-territorio" placeholder="Ej: 9" />
              </div>
            </div>

            <div class="turno">
              <h4>Tarde</h4>
              <div class="field-group">
                <label for="d6-tar-hora">Hora</label>
                <input type="text" id="d6-tar-hora" placeholder="Ej: 15:30" />
              </div>
              <div class="field-group">
                <label for="d6-tar-lugar">Lugar</label>
                <input type="text" id="d6-tar-lugar" placeholder="Ej: Salida Sal√≥n" />
              </div>
              <div class="field-group">
                <label for="d6-tar-conductor">Conductor</label>
                <input type="text" id="d6-tar-conductor" placeholder="Ej: Pedro" />
              </div>
              <div class="field-group">
                <label for="d6-tar-territorio">Territorio</label>
                <input type="text" id="d6-tar-territorio" placeholder="Ej: 12" />
              </div>
            </div>
          </details>
        </div>

        <button id="btn-guardar-programa">Guardar programa semanal</button>
        <div id="estado-programa" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>
    </section>

    <!-- üó∫Ô∏è TERRITORIOS -->
    <section id="territorios" class="section">
      <h2>Territorios</h2>

      <div class="card">
        <div class="card-header">Mapa general</div>
        <p>M√°s adelante pod√©s cargar el mapa y hacer detecci√≥n por color. Por ahora es solo informativo.</p>
        <p style="font-size:13px;color:#555;">Funci√≥n en construcci√≥n.</p>
      </div>
    </section>

    <!-- üë• INTERESADOS -->
    <section id="interesados" class="section">
      <h2>Interesados</h2>

      <div class="card">
        <div class="card-header">Nuevo interesado</div>

        <div class="field-group">
          <label for="int-nombre">Nombre</label>
          <input type="text" id="int-nombre" placeholder="Ej: Juan P√©rez" />
        </div>

        <div class="field-group">
          <label for="int-direccion">Direcci√≥n</label>
          <input type="text" id="int-direccion" placeholder="Ej: Av. Siempre Viva 123" />
        </div>

        <div class="field-group">
          <label for="int-nota">Observaci√≥n</label>
          <textarea id="int-nota" placeholder="Ej: Prefiere visitas por la tarde."></textarea>
        </div>

        <button id="btn-guardar-interesado">Guardar interesado</button>
        <div id="estado-interesado" style="margin-top:8px;font-size:13px;color:#555;"></div>
      </div>

      <div class="card">
        <div class="card-header">Listado de interesados</div>
        <div id="lista-interesados" style="margin-top:8px;font-size:13px;color:#555;">
          Todav√≠a no agregaste interesados.
        </div>
      </div>
    </section>

    <!-- ‚è±Ô∏è INFORME -->
    <section id="informe" class="section">
      <h2>Mi Informe</h2>

      <div class="tabs-informe">
        <button class="tab-btn active" data-tab="registro">Registro</button>
        <button class="tab-btn" data-tab="metas">Metas</button>
      </div>

      <!-- TAB REGISTRO -->
      <div id="tab-registro" class="tab-section active">
        <div class="card">
          <div class="card-header">Registro diario</div>

          <div class="field-group">
            <label for="reg-fecha">Fecha</label>
            <input type="date" id="reg-fecha" />
          </div>

          <div class="field-group">
            <label for="reg-horas">Horas</label>
            <input type="number" id="reg-horas" min="0" step="0.25" placeholder="Ej: 2.5" />
          </div>

          <div class="field-group">
            <label for="reg-cursos">Cursos b√≠blicos</label>
            <input type="number" id="reg-cursos" min="0" step="1" placeholder="Ej: 1" />
          </div>

          <button id="btn-agregar-registro">Agregar registro</button>
          <div id="estado-registro" style="margin-top:8px;font-size:13px;color:#555;"></div>
        </div>

        <div class="card">
          <div class="card-header">Mes a ver / editar</div>
          <div class="field-group">
            <label for="resumen-mes">Seleccion√° el mes</label>
            <input type="month" id="resumen-mes" />
            <p style="font-size:12px;color:#555;">El resumen mensual y la lista de registros usan este mes.</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Registros del mes seleccionado</div>
          <div id="lista-registros-mes" style="font-size:13px;color:#555;">
            No hay registros para este mes.
          </div>
        </div>
      </div>

      <!-- TAB METAS -->
      <div id="tab-metas" class="tab-section">
        <div class="card">
          <div class="card-header">Metas</div>

          <div class="field-group">
            <label for="meta-mensual">Meta de horas mensual</label>
            <input type="number" id="meta-mensual" min="0" step="0.25" placeholder="Ej: 30" />
          </div>

          <div class="field-group">
            <label for="meta-anual">Meta de horas anual (septiembre a agosto)</label>
            <input type="number" id="meta-anual" min="0" step="0.25" placeholder="Ej: 360" />
          </div>

          <button id="btn-guardar-metas">Guardar metas</button>
          <div id="estado-metas" style="margin-top:8px;font-size:13px;color:#555;"></div>
        </div>

        <div class="card">
          <div class="card-header">Resumen mensual (mes seleccionado)</div>
          <div id="resumen-mensual-detalle" style="font-size:13px;color:#555;">
            Todav√≠a no hay registros.
          </div>
        </div>

        <div class="card">
          <div class="card-header">Resumen anual (a√±o de servicio)</div>
          <div id="resumen-anual-detalle" style="font-size:13px;color:#555;">
            Todav√≠a no hay registros.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    console.log("Territorios App v5 READY");

    const diasSemana = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

    // --- Navegaci√≥n entre secciones principales ---
    const sections = document.querySelectorAll(".section");
    const navButtons = document.querySelectorAll(".nav-btn");

    function mostrarSeccion(id) {
      sections.forEach(sec => sec.classList.toggle("active", sec.id === id));
      navButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.section === id));
    }

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        mostrarSeccion(btn.dataset.section);
      });
    });

    // Header vuelve a INICIO
    const headerEl = document.querySelector("header");
    if (headerEl) {
      headerEl.addEventListener("click", () => {
        mostrarSeccion("inicio");
      });
    }

    // --- Tabs Mi Informe (Registro / Metas) ---
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabSections = document.querySelectorAll(".tab-section");

    function mostrarTab(id) {
      tabSections.forEach(tab => tab.classList.toggle("active", tab.id === id));
      tabButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === id.replace("tab-", "")));
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tabId = "tab-" + btn.dataset.tab;
        mostrarTab(tabId);
      });
    });

    // --- Helpers programa semanal (Salidas) ---
    function obtenerProgramaGuardado() {
      const guardado = localStorage.getItem("territorios_programaSemanal");
      if (!guardado) return {};
      try {
        return JSON.parse(guardado) || {};
      } catch (e) {
        return {};
      }
    }

    function normalizarDia(programaDia) {
      // Compatibilidad con versiones viejas (texto simple)
      if (!programaDia || typeof programaDia !== "object") {
        const territorio = programaDia != null ? String(programaDia) : "";
        return {
          manana: { hora: "", lugar: "", conductor: "", territorio },
          tarde:  { hora: "", lugar: "", conductor: "", territorio: "" }
        };
      }
      return {
        manana: {
          hora:       programaDia.manana && programaDia.manana.hora       ? programaDia.manana.hora       : "",
          lugar:      programaDia.manana && programaDia.manana.lugar      ? programaDia.manana.lugar      : "",
          conductor:  programaDia.manana && programaDia.manana.conductor  ? programaDia.manana.conductor  : "",
          territorio: programaDia.manana && programaDia.manana.territorio ? programaDia.manana.territorio : ""
        },
        tarde: {
          hora:       programaDia.tarde && programaDia.tarde.hora       ? programaDia.tarde.hora       : "",
          lugar:      programaDia.tarde && programaDia.tarde.lugar      ? programaDia.tarde.lugar      : "",
          conductor:  programaDia.tarde && programaDia.tarde.conductor  ? programaDia.tarde.conductor  : "",
          territorio: programaDia.tarde && programaDia.tarde.territorio ? programaDia.tarde.territorio : ""
        }
      };
    }

    function rellenarProgramaEnInputs() {
      const programa = obtenerProgramaGuardado();
      for (let i = 0; i < 7; i++) {
        const diaNorm = normalizarDia(programa[i]);
        const ids = [
          `d${i}-man-hora`,
          `d${i}-man-lugar`,
          `d${i}-man-conductor`,
          `d${i}-man-territorio`,
          `d${i}-tar-hora`,
          `d${i}-tar-lugar`,
          `d${i}-tar-conductor`,
          `d${i}-tar-territorio`
        ];
        const valores = [
          diaNorm.manana.hora,
          diaNorm.manana.lugar,
          diaNorm.manana.conductor,
          diaNorm.manana.territorio,
          diaNorm.tarde.hora,
          diaNorm.tarde.lugar,
          diaNorm.tarde.conductor,
          diaNorm.tarde.territorio
        ];
        ids.forEach((id, idx) => {
          const el = document.getElementById(id);
          if (el) el.value = valores[idx] || "";
        });
      }
    }

    function actualizarSalidaHoy(programaOpcional) {
      const salidaElem = document.getElementById("salida-hoy-texto");
      if (!salidaElem) return;

      let programa = programaOpcional;
      if (!programa) programa = obtenerProgramaGuardado();

      const hoy = new Date();
      const idx = hoy.getDay(); // 0=Domingo ... 6=S√°bado
      const diaNorm = normalizarDia(programa[idx]);

      const partes = [];

      function construirLineaTurno(titulo, datos) {
        const trozos = [];
        if (datos.hora) trozos.push(datos.hora);
        if (datos.lugar) trozos.push(datos.lugar);
        if (datos.conductor) trozos.push("Conductor: " + datos.conductor);
        if (datos.territorio) trozos.push("Territorio: " + datos.territorio);
        if (!trozos.length) return "";
        return "<strong>" + titulo + ":</strong> " + trozos.join(" ¬∑ ");
      }

      const lineaManana = construirLineaTurno("Ma√±ana", diaNorm.manana);
      const lineaTarde  = construirLineaTurno("Tarde",  diaNorm.tarde);

      if (lineaManana) partes.push(lineaManana);
      if (lineaTarde)  partes.push(lineaTarde);

      if (!partes.length) {
        salidaElem.textContent = "Todav√≠a no cargaste salida para hoy.";
      } else {
        salidaElem.innerHTML = partes.join("<br>");
      }
    }

    const btnGuardarPrograma = document.getElementById("btn-guardar-programa");
    const estadoPrograma = document.getElementById("estado-programa");

    if (btnGuardarPrograma) {
      btnGuardarPrograma.addEventListener("click", () => {
        const programa = {};
        for (let i = 0; i < 7; i++) {
          programa[i] = {
            manana: {
              hora:       (document.getElementById(`d${i}-man-hora`)?.value || "").trim(),
              lugar:      (document.getElementById(`d${i}-man-lugar`)?.value || "").trim(),
              conductor:  (document.getElementById(`d${i}-man-conductor`)?.value || "").trim(),
              territorio: (document.getElementById(`d${i}-man-territorio`)?.value || "").trim()
            },
            tarde: {
              hora:       (document.getElementById(`d${i}-tar-hora`)?.value || "").trim(),
              lugar:      (document.getElementById(`d${i}-tar-lugar`)?.value || "").trim(),
              conductor:  (document.getElementById(`d${i}-tar-conductor`)?.value || "").trim(),
              territorio: (document.getElementById(`d${i}-tar-territorio`)?.value || "").trim()
            }
          };
        }
        localStorage.setItem("territorios_programaSemanal", JSON.stringify(programa));
        if (estadoPrograma) estadoPrograma.textContent = "Programa semanal guardado.";
        actualizarSalidaHoy(programa);
      });
    }

    // --- INTERESADOS ---
    let listaInteresadosData = [];
    const contenedorInteresados = document.getElementById("lista-interesados");
    const estadoInteresado = document.getElementById("estado-interesado");

    function cargarInteresadosDesdeStorage() {
      const guardado = localStorage.getItem("interesados_lista");
      if (!guardado) {
        listaInteresadosData = [];
        return;
      }
      try {
        listaInteresadosData = JSON.parse(guardado) || [];
      } catch (e) {
        listaInteresadosData = [];
      }
    }

    function guardarInteresadosEnStorage() {
      localStorage.setItem("interesados_lista", JSON.stringify(listaInteresadosData));
    }

    function renderInteresados() {
      if (!contenedorInteresados) return;
      if (!listaInteresadosData.length) {
        contenedorInteresados.textContent = "Todav√≠a no agregaste interesados.";
        return;
      }

      contenedorInteresados.innerHTML = "";
      listaInteresadosData.forEach(item => {
        const card = document.createElement("div");
        card.style.border = "1px solid #e0e3ef";
        card.style.borderRadius = "8px";
        card.style.padding = "8px";
        card.style.marginBottom = "6px";
        card.style.background = "#f9f9fd";

        const nombre = document.createElement("div");
        nombre.style.fontWeight = "600";
        nombre.textContent = item.nombre || "(Sin nombre)";

        const dir = document.createElement("div");
        dir.style.fontSize = "13px";
        dir.textContent = item.direccion || "";

        const nota = document.createElement("div");
        nota.style.fontSize = "12px";
        nota.style.color = "#555";
        nota.textContent = item.nota || "";

        card.appendChild(nombre);
        if (item.direccion) card.appendChild(dir);
        if (item.nota) card.appendChild(nota);

        contenedorInteresados.appendChild(card);
      });
    }

    const btnGuardarInteresado = document.getElementById("btn-guardar-interesado");

    if (btnGuardarInteresado) {
      btnGuardarInteresado.addEventListener("click", () => {
        const nombreEl = document.getElementById("int-nombre");
        const dirEl    = document.getElementById("int-direccion");
        const notaEl   = document.getElementById("int-nota");

        const nombre    = nombreEl ? nombreEl.value.trim() : "";
        const direccion = dirEl    ? dirEl.value.trim()    : "";
        const nota      = notaEl   ? notaEl.value.trim()   : "";

        if (!nombre && !direccion && !nota) {
          if (estadoInteresado) estadoInteresado.textContent = "Carg√° al menos un dato para guardar.";
          return;
        }

        listaInteresadosData.push({ nombre, direccion, nota });
        guardarInteresadosEnStorage();
        renderInteresados();

        if (estadoInteresado) estadoInteresado.textContent = "Interesado guardado.";
        if (nombreEl) nombreEl.value = "";
        if (dirEl)    dirEl.value    = "";
        if (notaEl)   notaEl.value   = "";
      });
    }

    // --- INFORME ---
    let metas = { metaMensual: 0, metaAnual: 0 };
    let registrosHoras = [];

    const metaMensualInput = document.getElementById("meta-mensual");
    const metaAnualInput   = document.getElementById("meta-anual");
    const estadoMetas      = document.getElementById("estado-metas");

    const regFechaInput   = document.getElementById("reg-fecha");
    const regHorasInput   = document.getElementById("reg-horas");
    const regCursosInput  = document.getElementById("reg-cursos");
    const estadoRegistro  = document.getElementById("estado-registro");

    const resumenMensualDetalle = document.getElementById("resumen-mensual-detalle");
    const resumenAnualDetalle   = document.getElementById("resumen-anual-detalle");

    const resumenMesInput   = document.getElementById("resumen-mes");
    const listaRegistrosMes = document.getElementById("lista-registros-mes");

    function hoyISO() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, "0");
      const d = String(hoy.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function obtenerMesSeleccionado() {
      const ahora = new Date();
      let mes  = ahora.getMonth();      // 0-11
      let anio = ahora.getFullYear();

      if (resumenMesInput && resumenMesInput.value) {
        const partes = resumenMesInput.value.split("-");
        if (partes.length === 2) {
          const y = parseInt(partes[0], 10);
          const m = parseInt(partes[1], 10);
          if (!isNaN(y) && !isNaN(m)) {
            anio = y;
            mes  = m - 1; // input month 1-12
          }
        }
      }
      return { mes, anio };
    }

    function cargarMetasYRegistrosDesdeStorage() {
      const metasGuardadas = localStorage.getItem("informe_metas");
      if (metasGuardadas) {
        try {
          const obj = JSON.parse(metasGuardadas);
          metas.metaMensual = parseFloat(obj.metaMensual) || 0;
          metas.metaAnual   = parseFloat(obj.metaAnual)   || 0;
        } catch (e) {}
      }

      const regsGuardados = localStorage.getItem("informe_registrosHoras");
      if (regsGuardados) {
        try {
          registrosHoras = JSON.parse(regsGuardados) || [];
        } catch (e) {
          registrosHoras = [];
        }
      }

      if (metaMensualInput) metaMensualInput.value = metas.metaMensual || "";
      if (metaAnualInput)   metaAnualInput.value   = metas.metaAnual   || "";
      if (regFechaInput && !regFechaInput.value)   regFechaInput.value = hoyISO();

      // valor inicial del selector de mes
      if (resumenMesInput && !resumenMesInput.value) {
        resumenMesInput.value = hoyISO().slice(0, 7); // YYYY-MM
      }
    }

    function guardarMetasEnStorage() {
      localStorage.setItem("informe_metas", JSON.stringify(metas));
    }

    function guardarRegistrosEnStorage() {
      localStorage.setItem("informe_registrosHoras", JSON.stringify(registrosHoras));
    }

    function renderRegistrosMes() {
      if (!listaRegistrosMes) return;
      const { mes, anio } = obtenerMesSeleccionado();

      const registrosMes = registrosHoras
        .map((reg, index) => ({ ...reg, index }))
        .filter((reg) => {
          if (!reg.fecha) return false;
          const fecha = new Date(reg.fecha + "T00:00:00");
          return fecha.getMonth() === mes && fecha.getFullYear() === anio;
        });

      if (!registrosMes.length) {
        listaRegistrosMes.textContent = "No hay registros para este mes.";
        return;
      }

      listaRegistrosMes.innerHTML = "";
      registrosMes.forEach((reg) => {
        const fila = document.createElement("div");
        fila.style.border = "1px solid #e0e3ef";
        fila.style.borderRadius = "8px";
        fila.style.padding = "6px 8px";
        fila.style.marginBottom = "6px";
        fila.style.background = "#f9f9fd";
        fila.style.display = "flex";
        fila.style.justifyContent = "space-between";
        fila.style.alignItems = "center";
        fila.style.gap = "8px";

        const fechaObj = new Date(reg.fecha + "T00:00:00");
        let textoFecha;
        if (isNaN(fechaObj.getTime())) {
          textoFecha = reg.fecha;
        } else {
          const dd = String(fechaObj.getDate()).padStart(2, "0");
          const mm = String(fechaObj.getMonth() + 1).padStart(2, "0");
          const yy = fechaObj.getFullYear();
          textoFecha = `${dd}/${mm}/${yy}`;
        }

        const datos = document.createElement("div");
        datos.style.fontSize = "13px";
        const cursos = typeof reg.cursos === "number" ? reg.cursos : (parseInt(reg.cursos, 10) || 0);

        datos.innerHTML =
          `<strong>${textoFecha}</strong> ¬∑ ` +
          `Horas: ${Number(reg.horas || 0).toFixed(2)}` +
          ` ¬∑ Cursos: ${cursos}`;

        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.style.fontSize = "11px";
        btnEliminar.style.padding = "4px 8px";
        btnEliminar.addEventListener("click", () => {
          registrosHoras.splice(reg.index, 1);
          guardarRegistrosEnStorage();
          actualizarResumenes();
        });

        fila.appendChild(datos);
        fila.appendChild(btnEliminar);
        listaRegistrosMes.appendChild(fila);
      });
    }

    function actualizarResumenes() {
      const { mes: mesResumen, anio: anioResumen } = obtenerMesSeleccionado();

      // Total mensual (mes seleccionado)
      let totalMensual = 0;
      registrosHoras.forEach((reg) => {
        if (!reg.fecha) return;
        const fecha = new Date(reg.fecha + "T00:00:00");
        if (fecha.getMonth() === mesResumen && fecha.getFullYear() === anioResumen) {
          totalMensual += Number(reg.horas) || 0;
        }
      });

      // A√±o de servicio: septiembre a agosto, basado en mes/a√±o seleccionados
      let anioServicioInicio;
      if (mesResumen >= 8) {
        anioServicioInicio = anioResumen;
      } else {
        anioServicioInicio = anioResumen - 1;
      }
      const inicioServicio = new Date(anioServicioInicio, 8, 1);       // 1 septiembre
      const finServicio    = new Date(anioServicioInicio + 1, 8, 1);   // 1 septiembre siguiente

      let totalAnual = 0;
      registrosHoras.forEach((reg) => {
        if (!reg.fecha) return;
        const fecha = new Date(reg.fecha + "T00:00:00");
        if (fecha >= inicioServicio && fecha < finServicio) {
          totalAnual += Number(reg.horas) || 0;
        }
      });

      const metaMensual = metas.metaMensual || 0;
      const metaAnual   = metas.metaAnual   || 0;

      const faltanteMensual = Math.max(0, metaMensual - totalMensual);
      const faltanteAnual   = Math.max(0, metaAnual   - totalAnual);

      if (resumenMensualDetalle) {
        if (!metaMensual && !totalMensual && !totalAnual) {
          resumenMensualDetalle.textContent = "No cargaste metas ni registros para este mes.";
        } else {
          resumenMensualDetalle.innerHTML =
            "Meta mensual: <strong>" + metaMensual.toFixed(2) + " h</strong><br>" +
            "Horas registradas en el mes: <strong>" + totalMensual.toFixed(2) + " h</strong><br>" +
            "Faltan para la meta mensual: <strong>" + faltanteMensual.toFixed(2) + " h</strong><br><br>" +
            "Total acumulado en el a√±o de servicio: <strong>" + totalAnual.toFixed(2) + " h</strong>";
        }
      }

      if (resumenAnualDetalle) {
        const anioFinServicio = anioServicioInicio + 1;
        const textoRango =
          "A√±o de servicio: septiembre " +
          anioServicioInicio +
          " a agosto " +
          anioFinServicio;

        if (!metaAnual && !totalAnual) {
          resumenAnualDetalle.textContent =
            textoRango + ". Todav√≠a no cargaste metas ni registros.";
        } else {
          resumenAnualDetalle.innerHTML =
            textoRango + "<br>" +
            "Meta anual: <strong>" + metaAnual.toFixed(2) + " h</strong><br>" +
            "Horas registradas en el a√±o de servicio: <strong>" + totalAnual.toFixed(2) + " h</strong><br>" +
            "Faltan para la meta anual: <strong>" + faltanteAnual.toFixed(2) + " h</strong>";
        }
      }

      renderRegistrosMes();
    }

    const btnGuardarMetas = document.getElementById("btn-guardar-metas");
    if (btnGuardarMetas) {
      btnGuardarMetas.addEventListener("click", () => {
        const mensual = metaMensualInput ? parseFloat(metaMensualInput.value) : 0;
        const anual   = metaAnualInput   ? parseFloat(metaAnualInput.value)   : 0;
        metas.metaMensual = isNaN(mensual) ? 0 : mensual;
        metas.metaAnual   = isNaN(anual)   ? 0 : anual;
        guardarMetasEnStorage();
        if (estadoMetas) estadoMetas.textContent = "Metas guardadas.";
        actualizarResumenes();
      });
    }

    const btnAgregarRegistro = document.getElementById("btn-agregar-registro");
    if (btnAgregarRegistro) {
      btnAgregarRegistro.addEventListener("click", () => {
        const fecha  = regFechaInput  ? regFechaInput.value : "";
        const horas  = regHorasInput  ? parseFloat(regHorasInput.value)  : 0;
        const cursos = regCursosInput ? parseInt(regCursosInput.value, 10) : 0;

        if (!fecha || isNaN(horas) || horas <= 0) {
          if (estadoRegistro) estadoRegistro.textContent = "Carg√° una fecha y horas v√°lidas.";
          return;
        }

        registrosHoras.push({
          fecha,
          horas,
          cursos: isNaN(cursos) ? 0 : cursos
        });
        guardarRegistrosEnStorage();
        if (estadoRegistro) estadoRegistro.textContent = "Registro agregado.";
        if (regHorasInput)  regHorasInput.value  = "";
        if (regCursosInput) regCursosInput.value = "";
        actualizarResumenes();
      });
    }

    if (resumenMesInput) {
      resumenMesInput.addEventListener("change", () => {
        actualizarResumenes();
      });
    }

    // --- Inicializaci√≥n ---
    rellenarProgramaEnInputs();
    actualizarSalidaHoy();

    cargarInteresadosDesdeStorage();
    renderInteresados();

    cargarMetasYRegistrosDesdeStorage();
    actualizarResumenes();
  </script>
</body>
</html>

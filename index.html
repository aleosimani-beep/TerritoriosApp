<div class="app">
    <header>
      <div>
        <h1>TerritoriosApp</h1>
        <div class="subtitle">Salidas, territorios, interesados e informe personal</div>
      </div>
      <div class="badge">v1 ¬∑ localStorage</div>
    </header>

    <main>
      <!-- INICIO -->
      <section id="inicio">
        <div class="card">
          <div class="card-header">
            <h2>Salidas de hoy</h2>
            <span class="chip" id="chip-fecha-hoy"></span>
          </div>
          <div id="bloque-salidas-hoy">
            <p class="small-text">Cargando programa semanal...</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Atajos r√°pidos</h2>
          </div>
          <div class="flex-row">
            <a href="#salidas" class="flex-1" style="text-decoration:none;">
              <button class="flex-1" style="width:100%;">üìÖ Editar salidas</button>
            </a>
            <a href="#informe" class="flex-1" style="text-decoration:none;">
              <button class="flex-1 btn-secondary" style="width:100%;">‚è±Ô∏è Registrar horas</button>
            </a>
          </div>
          <p class="small-text" style="margin-top:0.5rem;">
            Todo se guarda autom√°ticamente en este dispositivo. Si borr√°s el historial o los datos del navegador, se pierde.
          </p>
        </div>
      </section>

      <!-- SALIDAS -->
      <section id="salidas">
        <div class="card">
          <div class="card-header">
            <h2>Programa semanal de salidas</h2>
            <span class="chip">Encuentros ma√±ana / tarde</span>
          </div>
          <p class="small-text">
            Defin√≠ para cada d√≠a el encuentro, hora, conductor y mapa de las salidas de ma√±ana y tarde.
          </p>

          <label for="salidas-mes">Mes del programa</label>
          <input id="salidas-mes" type="month" onchange="cambiarMesSalidas()" />

          <div class="salidas-grid salidas-grid-header" style="margin-top:0.6rem;">
            <div>D√≠a</div>
            <div>Ma√±ana</div>
            <div>Tarde</div>
          </div>
          <div id="contenedor-salidas-semana"></div>

          <button style="margin-top:0.6rem;" onclick="guardarSalidasSemana()">
            Guardar programa semanal
          </button>
          <div id="status-salidas" class="status-ok" style="display:none;"></div>
        </div>
      </section>

      <!-- TERRITORIOS -->
      <section id="territorios">
        <div class="card">
          <div class="card-header">
            <h2>Territorios</h2>
            <span class="chip" id="chip-total-territorios">0 registrados</span>
          </div>
          <p class="small-text">
            Pod√©s usar el color como referencia visual: verde = trabajado, amarillo = por hacer, rojo = pendiente.
          </p>

          <h3>Mapa general</h3>
          <label for="input-mapa">Subir imagen del mapa general</label>
          <input id="input-mapa" type="file" accept="image/*" onchange="subirMapaGeneral(event)" />
          <div id="mapa-preview-wrapper" style="margin-top:0.4rem; display:none;">
            <img id="mapa-preview" alt="Mapa general" style="max-width:100%; border-radius:0.5rem; border:1px solid #d1d5db; cursor:pointer;" onclick="abrirMapaAmpliado()" />
            <p class="small-text">Toc√° la imagen para verla ampliada.</p>
          </div>

          <h3 style="margin-top:0.9rem;">Nuevo territorio</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="territorio-nombre">Nombre / n√∫mero</label>
              <input id="territorio-nombre" type="text" placeholder="Territorio 12 - Centro" />
            </div>
            <div style="width:110px;">
              <label for="territorio-color">Color</label>
              <div class="fila-territorio">
                <input id="territorio-color" type="color" value="#22c55e" />
                <div class="territorio-color-preview" id="territorio-color-preview"></div>
              </div>
            </div>
          </div>
          <label for="territorio-notas">Notas</label>
          <textarea id="territorio-notas" placeholder="Referencias, zonas especiales, etc."></textarea>

          <button onclick="agregarTerritorio()">Agregar territorio</button>
          <div id="status-territorio" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Lista de territorios</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>Territorio</th>
                <th>Notas</th>
                <th>Color</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla-territorios"></tbody>
          </table>
          <p id="msg-sin-territorios" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste territorios.
          </p>
        </div>
      </section>

      <!-- INTERESADOS -->
      <section id="interesados">
        <div class="card">
          <div class="card-header">
            <h2>Interesados</h2>
            <span class="chip" id="chip-total-interesados">0 contactos</span>
          </div>

          <h3>Nuevo interesado</h3>
          <label for="int-nombre">Nombre</label>
          <input id="int-nombre" type="text" placeholder="Nombre y apellido" />

          <label for="int-direccion">Direcci√≥n / referencia</label>
          <input id="int-direccion" type="text" placeholder="Calle, n√∫mero, barrio..." />

          <div class="flex-row">
            <div class="flex-1">
              <label for="int-telefono">Tel√©fono</label>
              <input id="int-telefono" type="text" placeholder="Ej: 351-1234567" />
            </div>
            <div class="flex-1">
              <label for="int-territorio">Territorio</label>
              <input id="int-territorio" type="text" placeholder="Ej: T-12" />
            </div>
          </div>

          <label for="int-notas">Notas</label>
          <textarea id="int-notas" placeholder="Cu√°ndo se visit√≥, publicaciones, comentarios, etc."></textarea>

          <button onclick="agregarInteresado()">Agregar interesado</button>
          <div id="status-interesado" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Listado y b√∫squeda</h3>
          </div>
          <label for="buscador-interesados">Buscar por nombre, direcci√≥n o territorio</label>
          <input id="buscador-interesados" type="text" placeholder="Escrib√≠ para filtrar..." oninput="renderInteresados()" />

          <div id="lista-interesados"></div>
          <p id="msg-sin-interesados" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste interesados.
          </p>
        </div>
      </section>

      <!-- INFORME -->
      <section id="informe">
        <div class="card">
          <div class="card-header">
            <h2>Mi informe</h2>
            <span class="chip" id="chip-mes-informe"></span>
          </div>
          <h3>Metas</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="meta-horas">Horas meta (mes actual)</label>
              <input id="meta-horas" type="number" min="0" step="0.5" />
            </div>
            <div class="flex-1">
              <label for="meta-anual">Meta anual (septiembre‚Äìagosto)</label>
              <input id="meta-anual" type="number" min="0" step="1" />
            </div>
          </div>
          <button onclick="guardarMetas()">Guardar metas</button>
          <div id="status-meta" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <h3>Registro diario</h3>
          <div class="flex-row">
            <div class="flex-1">
              <label for="reg-fecha">Fecha</label>
              <input id="reg-fecha" type="date" />
            </div>
            <div style="width:110px;">
              <label for="reg-horas">Horas</label>
              <input id="reg-horas" type="number" min="0" step="0.25" />
            </div>
            <div style="width:110px;">
              <label for="reg-cursos">Cursos</label>
              <input id="reg-cursos" type="number" min="0" step="1" />
            </div>
          </div>

          <button onclick="agregarRegistroDiario()">Agregar al registro</button>
          <div id="status-registro" class="status-ok" style="display:none;"></div>
        </div>

        <div class="card">
          <h3>Resumen del mes</h3>
          <div id="resumen-mes"></div>
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Horas</th>
                <th>Cursos</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla-registro-diario"></tbody>
          </table>
          <p id="msg-sin-registro" class="small-text" style="margin-top:0.5rem; display:none;">
            Todav√≠a no cargaste registros para este mes.
          </p>
        </div>
      </section>
    </main>
  </div>

  <!-- NAV inferior (links simples) -->
  <div class="bottom-nav">
    <a href="#inicio">
      <span class="icon">üè†</span>
      <span>Inicio</span>
    </a>
    <a href="#salidas">
      <span class="icon">üìÖ</span>
      <span>Salidas</span>
    </a>
    <a href="#territorios">
      <span class="icon">üó∫Ô∏è</span>
      <span>Territorios</span>
    </a>
    <a href="#interesados">
      <span class="icon">üë•</span>
      <span>Interesados</span>
    </a>
    <a href="#informe">
      <span class="icon">‚è±Ô∏è</span>
      <span>Informe</span>
    </a>
  </div>

  <!-- Modal mapa ampliado -->
  <div id="mapa-modal" class="mapa-modal" onclick="cerrarMapaAmpliado(event)">
    <img id="mapa-modal-img" alt="Mapa general ampliado" />
    <button type="button" onclick="cerrarMapaAmpliado(event)">Cerrar ‚úï</button>
  </div>

  <script>
    const LS_SALIDAS = "territorios_salidasSemana";
    const LS_SALIDAS_MES = "territorios_salidasMes";
    const LS_TERRITORIOS = "territorios_lista";
    const LS_INTERESADOS = "territorios_interesados";
    const LS_META_HORAS = "territorios_metaHoras";
    const LS_META_ANUAL = "territorios_metaAnual";
    const LS_REGISTRO = "territorios_registroDiario";
    const LS_MAPA_GENERAL = "territorios_mapaGeneral";

    const DIAS = ["Jueves","Viernes","S√°bado","Domingo","Lunes","Martes","Mi√©rcoles"];

    function hoyISO() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function mesActualClave() {
      return hoyISO().slice(0,7);
    }

    function serviceYearKeyFromDate(dateStr) {
      if (!dateStr) return "";
      const partes = dateStr.split("-");
      if (partes.length < 2) return "";
      const year = parseInt(partes[0],10);
      const month = parseInt(partes[1],10);
      if (isNaN(year) || isNaN(month)) return "";
      const startYear = (month >= 9) ? year : year - 1;
      const endYear = startYear + 1;
      return startYear + "-" + endYear;
    }

    function currentServiceYearKey() {
      return serviceYearKeyFromDate(hoyISO());
    }

    function mostrarStatus(id, msg, ok) {
      if (ok === undefined) ok = true;
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = msg;
      el.style.display = "block";
      el.className = ok ? "status-ok" : "status-error";
      setTimeout(() => { el.style.display = "none"; }, 1500);
    }

    function cargarSalidasSemana() {
      const dataStr = localStorage.getItem(LS_SALIDAS);
      let salidasGuardadas = [];
      if (dataStr) {
        try { salidasGuardadas = JSON.parse(dataStr); } catch (e) {}
      }
      if (!Array.isArray(salidasGuardadas) || salidasGuardadas.length !== 7) {
        return DIAS.map(d => ({
          dia: d,
          mananaAct: "",
          mananaHora: "",
          mananaConductor: "",
          mananaMapa: "",
          tardeAct: "",
          tardeHora: "",
          tardeConductor: "",
          tardeMapa: ""
        }));
      }
      return DIAS.map((d, idx) => {
        const fila = salidasGuardadas[idx] || {};
        return {
          dia: d,
          mananaAct: (fila.mananaAct !== undefined) ? fila.mananaAct : (fila.manana || ""),
          mananaHora: fila.mananaHora || "",
          mananaConductor: fila.mananaConductor || "",
          mananaMapa: fila.mananaMapa || "",
          tardeAct: (fila.tardeAct !== undefined) ? fila.tardeAct : (fila.tarde || ""),
          tardeHora: fila.tardeHora || "",
          tardeConductor: fila.tardeConductor || "",
          tardeMapa: fila.tardeMapa || ""
        };
      });
    }

    function obtenerFechasSemanaMes(mesStr) {
      if (!mesStr) return ["","","","","","",""];
      const partes = mesStr.split("-");
      if (partes.length !== 2) return ["","","","","","",""];
      const year = parseInt(partes[0],10);
      const month = parseInt(partes[1],10);
      if (isNaN(year) || isNaN(month)) return ["","","","","","",""];

      const firstDay = new Date(year, month-1, 1);
      const firstDayDow = firstDay.getDay();
      const offsetToThursday = (4 - firstDayDow + 7) % 7;
      const firstThursdayDate = 1 + offsetToThursday;

      const fechas = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(year, month-1, firstThursdayDate + i);
        fechas.push(d.getDate());
      }
      return fechas;
    }

    function renderSalidasSemana() {
      const cont = document.getElementById("contenedor-salidas-semana");
      if (!cont) return;
      cont.innerHTML = "";
      const salidas = cargarSalidasSemana();
      const mesGuardado = localStorage.getItem(LS_SALIDAS_MES) || mesActualClave();
      const fechas = obtenerFechasSemanaMes(mesGuardado);

      salidas.forEach((fila, idx) => {
        const row = document.createElement("div");
        row.className = "salidas-grid";
        const numeroDia = fechas[idx] || "";
        const etiquetaDia = numeroDia ? `${fila.dia} ${numeroDia}` : fila.dia;

        row.innerHTML = `
          <div class="small-text">${etiquetaDia}</div>
          <div class="bloque-periodo">
            <div class="mini-label">Encuentro</div>
            <input type="text" id="manana-act-${idx}" value="${fila.mananaAct || ""}" placeholder="Ej: Encuentro 1" />
            <div class="flex-row">
              <div class="flex-1">
                <div class="mini-label">Hora</div>
                <input type="time" id="manana-hora-${idx}" value="${fila.mananaHora || ""}" />
              </div>
              <div class="flex-1">
                <div class="mini-label">Conductor</div>
                <input type="text" id="manana-cond-${idx}" value="${fila.mananaConductor || ""}" />
              </div>
            </div>
            <div class="mini-label">Mapa / punto de encuentro</div>
            <input type="text" id="manana-mapa-${idx}" value="${fila.mananaMapa || ""}" placeholder="Ej: Plaza X, Mapa 3" />
          </div>
          <div class="bloque-periodo">
            <div class="mini-label">Encuentro</div>
            <input type="text" id="tarde-act-${idx}" value="${fila.tardeAct || ""}" placeholder="Ej: Encuentro 2" />
            <div class="flex-row">
              <div class="flex-1">
                <div class="mini-label">Hora</div>
                <input type="time" id="tarde-hora-${idx}" value="${fila.tardeHora || ""}" />
              </div>
              <div class="flex-1">
                <div class="mini-label">Conductor</div>
                <input type="text" id="tarde-cond-${idx}" value="${fila.tardeConductor || ""}" />
              </div>
            </div>
            <div class="mini-label">Mapa / punto de encuentro</div>
            <input type="text" id="tarde-mapa-${idx}" value="${fila.tardeMapa || ""}" placeholder="Ej: Plaza Y, Mapa 4" />
          </div>
        `;
        cont.appendChild(row);
      });
    }

    function guardarSalidasSemana() {
      const salidas = DIAS.map((dia, idx) => ({
        dia,
        mananaAct: (document.getElementById(`manana-act-${idx}`) || {}).value || "",
        mananaHora: (document.getElementById(`manana-hora-${idx}`) || {}).value || "",
        mananaConductor: (document.getElementById(`manana-cond-${idx}`) || {}).value || "",
        mananaMapa: (document.getElementById(`manana-mapa-${idx}`) || {}).value || "",
        tardeAct: (document.getElementById(`tarde-act-${idx}`) || {}).value || "",
        tardeHora: (document.getElementById(`tarde-hora-${idx}`) || {}).value || "",
        tardeConductor: (document.getElementById(`tarde-cond-${idx}`) || {}).value || "",
        tardeMapa: (document.getElementById(`tarde-mapa-${idx}`) || {}).value || ""
      }));
      localStorage.setItem(LS_SALIDAS, JSON.stringify(salidas));
      mostrarStatus("status-salidas","Programa guardado ‚úÖ",true);
      renderSalidasHoy();
    }

    function cambiarMesSalidas() {
      const inp = document.getElementById("salidas-mes");
      if (!inp) return;
      const val = inp.value;
      if (!val) return;
      localStorage.setItem(LS_SALIDAS_MES, val);
      renderSalidasSemana();
    }

    function renderSalidasHoy() {
      const chip = document.getElementById("chip-fecha-hoy");
      const cont = document.getElementById("bloque-salidas-hoy");
      if (!chip || !cont) return;

      const hoy = new Date();
      const diaIndex = (hoy.getDay() + 3) % 7; // jueves=0 ... mi√©rcoles=6
      const fechaStr = hoy.toLocaleDateString("es-AR", {
        weekday: "long",
        day: "numeric",
        month: "long"
      });
      chip.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);

      const salidas = cargarSalidasSemana();
      const hoyFila = salidas[diaIndex];

      if (!hoyFila) {
        cont.innerHTML = '<p class="small-text">Para hoy no hay salidas configuradas en el programa semanal.</p>';
        return;
      }

      let html = "";
      const tieneManana = hoyFila.mananaAct || hoyFila.mananaHora || hoyFila.mananaMapa || hoyFila.mananaConductor;
      const tieneTarde = hoyFila.tardeAct || hoyFila.tardeHora || hoyFila.tardeMapa || hoyFila.tardeConductor;

      if (!tieneManana && !tieneTarde) {
        cont.innerHTML = '<p class="small-text">Para hoy no hay salidas configuradas en el programa semanal.</p>';
        return;
      }

      if (tieneManana) {
        html += `<p><strong>Ma√±ana:</strong> ${hoyFila.mananaHora || ""} ${hoyFila.mananaAct || ""}</p>`;
        const det = [];
        if (hoyFila.mananaConductor) det.push("Conductor: " + hoyFila.mananaConductor);
        if (hoyFila.mananaMapa) det.push("Mapa: " + hoyFila.mananaMapa);
        if (det.length) {
          html += `<p class="small-text">- ${det.join(" ¬∑ ")}</p>`;
        }
      }
      if (tieneTarde) {
        html += `<p style="margin-top:0.4rem;"><strong>Tarde:</strong> ${hoyFila.tardeHora || ""} ${hoyFila.tardeAct || ""}</p>`;
        const det2 = [];
        if (hoyFila.tardeConductor) det2.push("Conductor: " + hoyFila.tardeConductor);
        if (hoyFila.tardeMapa) det2.push("Mapa: " + hoyFila.tardeMapa);
        if (det2.length) {
          html += `<p class="small-text">- ${det2.join(" ¬∑ ")}</p>`;
        }
      }

      cont.innerHTML = html;
    }

    // TERRITORIOS
    function cargarTerritorios() {
      const dataStr = localStorage.getItem(LS_TERRITORIOS);
      let lista = [];
      if (dataStr) {
        try { lista = JSON.parse(dataStr); } catch(e){}
      }
      if (!Array.isArray(lista)) lista = [];
      return lista;
    }

    function guardarTerritorios(lista) {
      localStorage.setItem(LS_TERRITORIOS, JSON.stringify(lista));
    }

    function renderTerritorios() {
      const lista = cargarTerritorios();
      const tbody = document.getElementById("tabla-territorios");
      const chip = document.getElementById("chip-total-territorios");
      const msgSin = document.getElementById("msg-sin-territorios");
      if (!tbody || !chip || !msgSin) return;

      tbody.innerHTML = "";
      chip.textContent = `${lista.length} registrados`;

      if (!lista.length) {
        msgSin.style.display = "block";
        return;
      }
      msgSin.style.display = "none";

      lista.forEach((t, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.nombre || ""}</td>
          <td>${t.notas || ""}</td>
          <td>
            <div style="display:flex; align-items:center; gap:0.3rem;">
              <div style="width:16px; height:16px; border-radius:4px; border:1px solid #d1d5db; background:${t.color || "#ffffff"};"></div>
              <span class="small-text">${t.color || ""}</span>
            </div>
          </td>
          <td><button class="btn-danger btn-small" onclick="eliminarTerritorio(${idx})">‚úï</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function agregarTerritorio() {
      const nombreEl = document.getElementById("territorio-nombre");
      const colorEl = document.getElementById("territorio-color");
      const notasEl = document.getElementById("territorio-notas");
      if (!nombreEl || !colorEl || !notasEl) return;

      const nombre = nombreEl.value.trim();
      const color = colorEl.value;
      const notas = notasEl.value.trim();

      if (!nombre) {
        mostrarStatus("status-territorio","Pon√© un nombre o n√∫mero de territorio",false);
        return;
      }

      const lista = cargarTerritorios();
      lista.push({ id: Date.now(), nombre, color, notas });
      guardarTerritorios(lista);
      renderTerritorios();

      nombreEl.value = "";
      notasEl.value = "";
      mostrarStatus("status-territorio","Territorio agregado ‚úÖ",true);
    }

    function eliminarTerritorio(idx) {
      const lista = cargarTerritorios();
      if (idx < 0 || idx >= lista.length) return;
      if (!confirm("¬øEliminar este territorio?")) return;
      lista.splice(idx,1);
      guardarTerritorios(lista);
      renderTerritorios();
    }

    function mostrarMapaPreview(dataUrl) {
      const wrapper = document.getElementById("mapa-preview-wrapper");
      const img = document.getElementById("mapa-preview");
      if (!wrapper || !img) return;
      if (dataUrl) {
        img.src = dataUrl;
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "none";
      }
    }

    function cargarMapaGeneral() {
      const dataUrl = localStorage.getItem(LS_MAPA_GENERAL);
      if (dataUrl) mostrarMapaPreview(dataUrl);
    }

    function subirMapaGeneral(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        localStorage.setItem(LS_MAPA_GENERAL, dataUrl);
        mostrarMapaPreview(dataUrl);
        mostrarStatus("status-territorio","Mapa general guardado ‚úÖ",true);
      };
      reader.readAsDataURL(file);
    }

    function abrirMapaAmpliado() {
      const dataUrl = localStorage.getItem(LS_MAPA_GENERAL);
      if (!dataUrl) return;
      const modal = document.getElementById("mapa-modal");
      const img = document.getElementById("mapa-modal-img");
      if (!modal || !img) return;
      img.src = dataUrl;
      modal.style.display = "flex";
    }

    function cerrarMapaAmpliado(ev) {
      if (ev) ev.stopPropagation();
      const modal = document.getElementById("mapa-modal");
      if (!modal) return;
      modal.style.display = "none";
    }

    // INTERESADOS
    function cargarInteresados() {
      const dataStr = localStorage.getItem(LS_INTERESADOS);
      let lista = [];
      if (dataStr) {
        try { lista = JSON.parse(dataStr); } catch(e){}
      }
      if (!Array.isArray(lista)) lista = [];
      return lista;
    }

    function guardarInteresados(lista) {
      localStorage.setItem(LS_INTERESADOS, JSON.stringify(lista));
    }

    function agregarInteresado() {
      const nombreEl = document.getElementById("int-nombre");
      const dirEl = document.getElementById("int-direccion");
      const telEl = document.getElementById("int-telefono");
      const terrEl = document.getElementById("int-territorio");
      const notasEl = document.getElementById("int-notas");
      if (!nombreEl || !dirEl || !telEl || !terrEl || !notasEl) return;

      const nombre = nombreEl.value.trim();
      const dir = dirEl.value.trim();
      const tel = telEl.value.trim();
      const terr = terrEl.value.trim();
      const notas = notasEl.value.trim();

      if (!nombre) {
        mostrarStatus("status-interesado","Pon√© al menos el nombre",false);
        return;
      }

      const lista = cargarInteresados();
      lista.push({ id: Date.now(), nombre, direccion: dir, telefono: tel, territorio: terr, notas });
      guardarInteresados(lista);

      nombreEl.value = "";
      dirEl.value = "";
      telEl.value = "";
      terrEl.value = "";
      notasEl.value = "";

      renderInteresados();
      mostrarStatus("status-interesado","Interesado agregado ‚úÖ",true);
    }

    function eliminarInteresado(id) {
      const lista = cargarInteresados();
      const idx = lista.findIndex(i => i.id === id);
      if (idx === -1) return;
      if (!confirm("¬øEliminar este interesado?")) return;
      lista.splice(idx,1);
      guardarInteresados(lista);
      renderInteresados();
    }

    function renderInteresados() {
      const lista = cargarInteresados();
      const cont = document.getElementById("lista-interesados");
      const chip = document.getElementById("chip-total-interesados");
      const msgSin = document.getElementById("msg-sin-interesados");
      const filtroEl = document.getElementById("buscador-interesados");
      if (!cont || !chip || !msgSin || !filtroEl) return;

      const filtro = filtroEl.value.trim().toLowerCase();
      chip.textContent = `${lista.length} contactos`;
      cont.innerHTML = "";

      const filtrados = lista.filter(i => {
        if (!filtro) return true;
        const txt = (i.nombre + " " + i.direccion + " " + i.territorio).toLowerCase();
        return txt.includes(filtro);
      });

      if (!lista.length) {
        msgSin.style.display = "block";
      } else {
        msgSin.style.display = "none";
      }

      if (!filtrados.length && lista.length) {
        cont.innerHTML = '<p class="small-text">No hay resultados para ese filtro.</p>';
        return;
      }

      filtrados.forEach(i => {
        const div = document.createElement("div");
        div.className = "interesado-card";
        let detalle = "";
        if (i.direccion) detalle += `<strong>Direcci√≥n:</strong> ${i.direccion}<br/>`;
        if (i.telefono) detalle += `<strong>Tel:</strong> ${i.telefono}<br/>`;
        if (i.territorio) detalle += `<strong>Territorio:</strong> ${i.territorio}<br/>`;
        if (i.notas) detalle += `<strong>Notas:</strong> ${i.notas}`;

        div.innerHTML = `
          <div class="interesado-nombre">${i.nombre}</div>
          <div class="interesado-detalle">${detalle}</div>
          <div style="margin-top:0.25rem;">
            <button class="btn-danger btn-small" onclick="eliminarInteresado(${i.id})">Eliminar</button>
          </div>
        `;
        cont.appendChild(div);
      });
    }

    // INFORME
    function cargarMetaHoras() {
      const dataStr = localStorage.getItem(LS_META_HORAS);
      if (!dataStr) return {};
      try { return JSON.parse(dataStr); } catch(e){}
      return {};
    }

    function cargarMetaAnual() {
      const dataStr = localStorage.getItem(LS_META_ANUAL);
      if (!dataStr) return {};
      try { return JSON.parse(dataStr); } catch(e){}
      return {};
    }

    function guardarMetas() {
      const metaHorasEl = document.getElementById("meta-horas");
      const metaAnualEl = document.getElementById("meta-anual");
      if (!metaHorasEl || !metaAnualEl) return;

      const metaHorasStr = metaHorasEl.value.trim();
      const metaMensual = metaHorasStr ? parseFloat(metaHorasStr) : 0;
      const metaAnualStr = metaAnualEl.value.trim();
      const metaAnualVal = metaAnualStr ? parseFloat(metaAnualStr) : 0;

      const metasMes = cargarMetaHoras();
      metasMes[mesActualClave()] = isNaN(metaMensual) ? 0 : metaMensual;
      localStorage.setItem(LS_META_HORAS, JSON.stringify(metasMes));

      const metasAnual = cargarMetaAnual();
      metasAnual[currentServiceYearKey()] = isNaN(metaAnualVal) ? 0 : metaAnualVal;
      localStorage.setItem(LS_META_ANUAL, JSON.stringify(metasAnual));

      mostrarStatus("status-meta","Metas guardadas ‚úÖ",true);
      actualizarResumenInforme();
    }

    function cargarRegistro() {
      const dataStr = localStorage.getItem(LS_REGISTRO);
      let lista = [];
      if (dataStr) {
        try { lista = JSON.parse(dataStr); } catch(e){}
      }
      if (!Array.isArray(lista)) lista = [];
      return lista;
    }

    function guardarRegistro(lista) {
      localStorage.setItem(LS_REGISTRO, JSON.stringify(lista));
    }

    function agregarRegistroDiario() {
      const fechaEl = document.getElementById("reg-fecha");
      const horasEl = document.getElementById("reg-horas");
      const cursosEl = document.getElementById("reg-cursos");
      if (!fechaEl || !horasEl || !cursosEl) return;

      const fecha = fechaEl.value || hoyISO();
      const horasStr = horasEl.value.trim();
      const horas = horasStr ? parseFloat(horasStr) : 0;
      const cursosStr = cursosEl.value.trim();
      const cursos = cursosStr ? parseInt(cursosStr,10) : 0;

      if (!horas || isNaN(horas)) {
        mostrarStatus("status-registro","Indic√° cu√°ntas horas hiciste",false);
        return;
      }

      const lista = cargarRegistro();
      lista.push({ id: Date.now(), fecha, horas, cursos: isNaN(cursos) ? 0 : cursos });
      guardarRegistro(lista);

      fechaEl.value = "";
      horasEl.value = "";
      cursosEl.value = "";

      mostrarStatus("status-registro","Registro agregado ‚úÖ",true);
      actualizarResumenInforme();
    }

    function eliminarRegistro(id) {
      const lista = cargarRegistro();
      const idx = lista.findIndex(r => r.id === id);
      if (idx === -1) return;
      if (!confirm("¬øEliminar este registro?")) return;
      lista.splice(idx,1);
      guardarRegistro(lista);
      actualizarResumenInforme();
    }

    function actualizarResumenInforme() {
      const mesClave = mesActualClave();
      const chip = document.getElementById("chip-mes-informe");
      const resumenDiv = document.getElementById("resumen-mes");
      const tbody = document.getElementById("tabla-registro-diario");
      const msgSin = document.getElementById("msg-sin-registro");
      if (!chip || !resumenDiv || !tbody || !msgSin) return;

      const fecha = new Date();
      const nombreMes = fecha.toLocaleDateString("es-AR",{month:"long", year:"numeric"});
      chip.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);

      const metasMes = cargarMetaHoras();
      const metaMensual = metasMes[mesClave] || 0;

      const metasAnual = cargarMetaAnual();
      const servKey = currentServiceYearKey();
      const metaAnual = metasAnual[servKey] || 0;

      const registrosTodos = cargarRegistro();
      const registrosMes = registrosTodos.filter(r => (r.fecha || "").startsWith(mesClave));
      const registrosServiceYear = registrosTodos.filter(r => serviceYearKeyFromDate(r.fecha || "") === servKey);

      tbody.innerHTML = "";
      if (!registrosMes.length) {
        msgSin.style.display = "block";
      } else {
        msgSin.style.display = "none";
      }

      let totalHorasMes = 0;
      let totalCursosMes = 0;
      registrosMes.sort((a,b) => (a.fecha || "").localeCompare(b.fecha || ""));
      registrosMes.forEach(r => {
        totalHorasMes += r.horas || 0;
        totalCursosMes += r.cursos || 0;
        const tr = document.createElement("tr");
        const fechaFmt = new Date((r.fecha || "") + "T00:00:00").toLocaleDateString("es-AR",{day:"2-digit", month:"2-digit"});
        tr.innerHTML = `
          <td>${fechaFmt}</td>
          <td>${(r.horas || 0).toFixed(2)}</td>
          <td>${r.cursos || 0}</td>
          <td><button class="btn-danger btn-small" onclick="eliminarRegistro(${r.id})">‚úï</button></td>
        `;
        tbody.appendChild(tr);
      });

      let totalHorasAnual = 0;
      registrosServiceYear.forEach(r => { totalHorasAnual += r.horas || 0; });

      let textoMetaMensual = "";
      if (!metaMensual) {
        textoMetaMensual = "No configuraste una meta mensual de horas.";
      } else if (totalHorasMes >= metaMensual) {
        textoMetaMensual = `Meta mensual de ${metaMensual.toFixed(2)} horas alcanzada ‚úÖ (llev√°s ${totalHorasMes.toFixed(2)} h).`;
      } else {
        const diff = metaMensual - totalHorasMes;
        textoMetaMensual = `Llev√°s ${totalHorasMes.toFixed(2)} h de ${metaMensual.toFixed(2)} h. Te faltan ${diff.toFixed(2)} h.`;
      }

      let textoMetaAnual = "";
      if (!metaAnual) {
        textoMetaAnual = `Meta anual no configurada para el a√±o de servicio ${servKey}.`;
      } else if (totalHorasAnual >= metaAnual) {
        textoMetaAnual = `Meta anual de ${metaAnual.toFixed(0)} h alcanzada ‚úÖ (llev√°s ${totalHorasAnual.toFixed(2)} h).`;
      } else {
        const diffA = metaAnual - totalHorasAnual;
        textoMetaAnual = `A√±o de servicio ${servKey}: llev√°s ${totalHorasAnual.toFixed(2)} h de ${metaAnual.toFixed(0)} h. Te faltan ${diffA.toFixed(2)} h.`;
      }

      resumenDiv.innerHTML = `
        <div class="resumen-destacado">
          <div class="resumen-linea">
            <span>Total de horas del mes</span>
            <strong>${totalHorasMes.toFixed(2)} h</strong>
          </div>
          <div class="resumen-linea">
            <span>Total de cursos del mes</span>
            <strong>${totalCursosMes}</strong>
          </div>
          <div class="resumen-linea">
            <span>Meta mensual configurada</span>
            <strong>${metaMensual ? metaMensual.toFixed(2) + " h" : "Sin meta"}</strong>
          </div>
          <div class="resumen-linea">
            <span>Horas en a√±o de servicio (${servKey})</span>
            <strong>${totalHorasAnual.toFixed(2)} h</strong>
          </div>
        </div>
        <p class="small-text" style="margin-top:0.2rem;">${textoMetaMensual}</p>
        <p class="small-text" style="margin-top:0.2rem;">${textoMetaAnual}</p>
      `;

      const metaHorasEl = document.getElementById("meta-horas");
      const metaAnualEl = document.getElementById("meta-anual");
      if (metaHorasEl) metaHorasEl.value = metaMensual || "";
      if (metaAnualEl) metaAnualEl.value = metaAnual || "";
    }

    window.addEventListener("load", () => {
      const colorInp = document.getElementById("territorio-color");
      const colorPrev = document.getElementById("territorio-color-preview");
      if (colorInp && colorPrev) {
        colorPrev.style.background = colorInp.value;
        colorInp.addEventListener("input", () => {
          colorPrev.style.background = colorInp.value;
        });
      }

      const inpMesSalidas = document.getElementById("salidas-mes");
      if (inpMesSalidas) {
        const mesGuardado = localStorage.getItem(LS_SALIDAS_MES) || mesActualClave();
        inpMesSalidas.value = mesGuardado;
        localStorage.setItem(LS_SALIDAS_MES, mesGuardado);
      }

      renderSalidasSemana();
      renderSalidasHoy();
      renderTerritorios();
      renderInteresados();
      cargarMapaGeneral();
      actualizarResumenInforme();

      const regFecha = document.getElementById("reg-fecha");
      if (regFecha) regFecha.value = hoyISO();
    });
  </script>
